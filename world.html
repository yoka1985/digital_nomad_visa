<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomad/Long Stay Visa Explorer - Interactive World Map</title>
    
    <meta name="description" content="Explore digital nomad visa requirements worldwide with our interactive map. Compare visa duration, costs, income requirements, and bureaucracy levels for 190+ countries.">
    <meta name="keywords" content="digital nomad visa, remote work visa, nomad visa requirements, visa duration, visa cost, tax friendliness, bureaucracy level, world map, visa comparison">
    <meta name="author" content="Nomad/Long Stay Visa Explorer">
    <meta name="robots" content="index, follow">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/nomadvisa.help">
    <meta property="og:title" content="Nomad/Long Stay Visa Explorer - Interactive World Map">
    <meta property="og:description" content="Explore digital nomad visa requirements worldwide with our interactive map. Compare visa duration, costs, income requirements for 190+ countries.">
    <meta property="og:image" content="https://example.com/nomad-visa-preview.png">
    <meta property="og:site_name" content="Nomad/Long Stay Visa Explorer">
    
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://example.com/nomadvisa.help">
    <meta property="twitter:title" content="Nomad/Long Stay Visa Explorer - Interactive World Map">
    <meta property="twitter:description" content="Explore digital nomad visa requirements worldwide with our interactive map. Compare visa duration, costs, income requirements for 190+ countries.">
    <meta property="twitter:image" content="https://example.com/nomadvisa.png">
    
    <meta name="geo.region" content="Global">
    <meta name="geo.placename" content="Worldwide">
    <meta name="ICBM" content="0, 0">
    
    <link rel="canonical" href="https://example.com/nomadvisa.help">
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Nomad Visa Explorer",
        "description": "Interactive world map for exploring digital nomad visa requirements, costs, and bureaucracy levels across 190+ countries",
        "url": "https://example.com/nomadvisa.help",
        "applicationCategory": "Travel",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "Nomad/Long Stay Visa Explorer"
        }
    }
    </script>
        <script>document.addEventListener('contextmenu', e => e.preventDefault());    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6N573S8D8S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', { 'analytics_storage': 'denied' });
        function initGoogleAnalytics() {
            gtag('consent', 'update', { 'analytics_storage': 'granted' });
            gtag('js', new Date());
            gtag('config', 'G-6N573S8D8S');
            console.log("Google Analytics Initialized");
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: #e2e8f0; 
            overflow: hidden;
            position: relative;
        }
        
        .main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        svg { 
            width: 100%; 
            height: 100%; 
            display: block; 
            background: #0f172a;
        }
        
        .controls { 
            position: fixed; 
            top: 1rem; 
            left: 1rem; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 0.6rem;
            background: rgba(15, 23, 42, 0.95);
            padding: 0.8rem;
            border-radius: 10px;
            border: 2px solid #38bdf8;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(56, 189, 248, 0.3);
            max-width: 250px;
            min-width: 220px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .title { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: #38bdf8; 
            text-shadow: 0 0 12px rgba(56, 189, 248, 0.6); 
            margin-bottom: 0.3rem;
            text-align: center;
            line-height: 1.2;
        }
        
        .subtitle {
            font-size: 0.9rem;
            font-weight: 600;
            color: #facc15;
            text-align: center;
            margin-bottom: 0.6rem;
            padding: 0.4rem;
            background: rgba(250, 204, 21, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(250, 204, 21, 0.3);
            line-height: 1.3;
        }
        
        .filter-explanation {
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: center;
            margin-bottom: 0.6rem;
            line-height: 1.4;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #38bdf8;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            text-align: center;
            justify-content: center;
        }
        
        .back-link:hover {
            background: rgba(56, 189, 248, 0.15);
            border-color: #38bdf8;
            transform: translateX(-2px);
        }
        
        label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #94a3b8;
            margin-bottom: 0.2rem;
        }
        
        select { 
            padding: 0.6rem; 
            font-size: 0.85rem; 
            font-weight: 500; 
            border-radius: 6px; 
            border: 2px solid #38bdf8; 
            background: #1e293b;
            color: #e2e8f0; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); 
            outline: none; 
            width: 100%;
            transition: all 0.3s ease;
        }
        
        select:focus {
            border-color: #facc15;
            box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.2);
        }
        
        .share-button {
            padding: 0.7rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
            border: 2px solid #38bdf8;
            background: linear-gradient(135deg, #1e293b, #2563eb);
            color: #e2e8f0;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .share-button:hover {
            background: linear-gradient(135deg, #38bdf8, #06b6d4);
            color: #0f172a;
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(56, 189, 248, 0.4);
        }
        
        .share-button:active {
            transform: translateY(0);
        }
        
        .share-button.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .legend { 
            position: fixed; 
            top: 1rem; 
            right: 1rem; 
            background: rgba(15, 23, 42, 0.95);
            padding: 0.8rem; 
            border-radius: 10px; 
            box-shadow: 0 8px 32px rgba(56, 189, 248, 0.3); 
            z-index: 1000; 
            border: 2px solid #38bdf8; 
            backdrop-filter: blur(12px);
            min-width: 180px;
            max-width: 220px;
        }
        
        .legend-title { 
            font-weight: 700; 
            color: #38bdf8; 
            margin-bottom: 0.6rem; 
            font-size: 0.9rem;
            text-align: center;
            line-height: 1.2;
        }
        
        .legend-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 0.4rem; 
            padding: 0.3rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .legend-item:hover {
            background: rgba(56, 189, 248, 0.1);
        }
        
        .legend-color { 
            width: 16px; 
            height: 16px; 
            margin-right: 8px; 
            border-radius: 3px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }
        
        .legend-text { 
            font-size: 0.8rem; 
            font-weight: 500;
            line-height: 1.3;
        }
        
        .tooltip { 
            position: absolute; 
            background: #1e293b; 
            padding: 0.7rem 1.2rem; 
            border-radius: 8px; 
            border: 2px solid #38bdf8; 
            color: #e2e8f0; 
            font-size: 0.9rem; 
            font-weight: 500;
            pointer-events: none; 
            z-index: 3000;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
            max-width: 250px;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(56, 189, 248, 0.3);
            padding: 0.8rem 1rem;
        }
        
        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .footer-link {
            color: #64748b;
            text-decoration: none;
            transition: color 0.2s ease;
            padding: 0.2rem 0;
            background: none;
            border: none;
            cursor: pointer;
            font-size: inherit;
            font-family: inherit;
        }
        
        .footer-link:hover {
            color: #38bdf8;
        }
        
        .footer-separator {
            color: #475569;
        }
        
        .footer-copyright {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.7rem;
            color: #475569;
            line-height: 1.3;
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(6px);
            padding: 1rem;
        }
        
        .popup { 
            position: relative; 
            background: #1e293b; 
            padding: 2rem; 
            border-radius: 16px; 
            box-shadow: 0 12px 40px rgba(56, 189, 248, 0.4); 
            max-width: 90vw; 
            width: 500px; 
            font-size: 1rem; 
            color: #e2e8f0; 
            border: 2px solid #facc15; 
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .popup .header { 
            font-size: 1.5rem; 
            font-weight: 700; 
            margin-bottom: 1.5rem; 
            color: #38bdf8;
            text-align: center;
            border-bottom: 2px solid #38bdf8;
            padding-bottom: 0.8rem;
        }
        
        .popup .row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 1.2rem; 
            padding: 0.8rem;
            background: rgba(56, 189, 248, 0.08);
            border-radius: 8px;
            border-left: 3px solid #38bdf8;
        }
        
        .popup .icon { 
            margin-right: 1rem; 
            font-size: 1.4rem; 
            width: 28px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .qualitative-ratings-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #facc15;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #facc15;
        }
        
        .qualitative-row {
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(15, 23, 42, 0.8);
            border-left: 4px solid #64748b;
            border-radius: 8px;
        }
        
        .qualitative-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
        }
        
        .qualitative-title strong {
            color: #94a3b8;
            font-size: 1rem;
        }
        
        .qualitative-stars {
            font-size: 1.2rem;
            color: #facc15;
        }
        
        .qualitative-explanation {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin: 0;
            line-height: 1.6;
        }
        
        path { 
            stroke: #0f172a; 
            stroke-width: 0.5; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        
        path:hover { 
            fill-opacity: 0.8; 
  _B_L_O_C_K_       stroke-width: 2;
            stroke: #38bdf8;
        }
        
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
            padding: 1rem;
        }
        
        .share-modal-content {
            background: #1e293b;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #38bdf8;
            box-shadow: 0 25px 80px rgba(56, 189, 248, 0.4);
            width: 100%;
            max-width: 600px;
        }
        
        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #38bdf8;
            padding-bottom: 1rem;
        }
        
        .share-modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #38bdf8;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            transform: rotate(90deg);
        }
        
        .share-preview {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .share-preview canvas {
            max-width: 100%;
            border-radius: 12px;
            border: 2px solid #38bdf8;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .share-option {
            display: flex;
            align-items: center;
          _B_L_O_C_K_   padding: 1.2rem;
            background: linear-gradient(135deg, #334155, #475569);
            border: 2px solid #64748b;
            border-radius: 12px;
            color: #e2e8f0;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .share-option:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border-color: #38bdf8;
        }
        
        .share-option.twitter:hover { background: linear-gradient(135deg, #1da1f2, #0d8bd9); }
        .share-option.facebook:hover { background: linear-gradient(135deg, #1877f2, #166fe5); }
        .share-option.linkedin:hover { background: linear-gradient(135deg, #0077b5, #005885); }
        .share-option.reddit:hover { background: linear-gradient(135deg, #ff4500, #e03d00); }
        .share-option.whatsapp:hover { background: linear-gradient(135deg, #25d366, #1da851); }
        .share-option.telegram:hover { background: linear-gradient(135deg, #0088cc, #006699); }
        
        .share-icon {
            font-size: 1.8rem;
            margin-right: 1rem;
        }
        
        .share-text {
            font-weight: 600;
        }
        
        .download-section {
            border-top: 2px solid #38bdf8;
            padding-top: 2rem;
            text-align: center;
        }
        
        .download-button {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 1rem;
        }
        
        .download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
        }
        
        .copy-url-button {
            background: #374151;
            color: #e2e8f0;
            border: 2px solid #64748b;
        }
        
        .copy-url-button:hover {
            background: #38bdf8;
            color: #0f172a;
            border-color: #38bdf8;
        }
        
        .share-url {
            background: #334155;
            border: 2px solid #64748b;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            word-break: break-all;
            color: #e2e8f0;
            line-height: 1.4;
        }
        
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #7f1d1d;
            color: #fca5a5;
            padding: 2rem;
            border-radius: 16px;
            border: 2px solid #dc2626;
            text-align: center;
            z-index: 10000;
            max-width: 90vw;
            width: 500px;
        }
        
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #38bdf8;
            font-size: 2rem;
            z-index: 9999;
            text-align: center;
        }
        
        /* Legal Modal Styles */
        .legal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(6px);
            padding: 1rem;
        }
        
        .legal-modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #38bdf8;
            box-shadow: 0 12px 40px rgba(56, 189, 248, 0.4);
            width: 100%;
            max-width: 600px;
        }
        
        .legal-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #38bdf8;
            padding-bottom: 1rem;
        }
        
        .legal-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #38bdf8;
            margin: 0;
        }
        
        .legal-modal-body {
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .legal-modal-body p {
            margin-bottom: 1rem;
        }


        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                height: 100vh;
            }
            
            .controls {
                top: 0.5rem;
                left: 0.5rem;
                right: 0.5rem;
                max-width: none;
                min-width: 0;
                padding: 0.6rem;
                border-radius: 8px;
                position: fixed;
                width: calc(100vw - 1rem);
            }
            
            .title {
                font-size: 1rem;
                margin-bottom: 0.2rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
                padding: 0.3rem;
                margin-bottom: 0.4rem;
            }
            
            .filter-explanation {
                font-size: 0.75rem;
                margin-bottom: 0.4rem;
            }
            
            .legend {
                top: auto;
                bottom: 5rem;
                right: 0.5rem;
                left: 0.5rem;
                min-width: 0;
                max-width: none;
                padding: 0.6rem;
                border-radius: 8px;
            }
            
            .legend-title {
                font-size: 0.8rem;
                margin-bottom: 0.4rem;
            }
            
            .legend-item {
                margin-bottom: 0.3rem;
                padding: 0.2rem;
            }
            
            .legend-text {
                font-size: 0.75rem;
            }
            
            .footer {
                position: fixed;
                padding: 0.5rem;
            }
            
            .footer-content {
                font-size: 0.7rem;
                gap: 0.3rem 0.8rem;
            }
            
            .footer-copyright {
                font-size: 0.65rem;
                margin-top: 0.3rem;
            }
            
            .popup {
                width: 95vw;
                max-width: none;
                padding: 1.5rem;
                max-height: 80vh;
            }
            
            .popup .header {
                font-size: 1.3rem;
                margin-bottom: 1.2rem;
            }
            
            .popup .row {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                padding: 0.8rem;
                margin-bottom: 1rem;
            }
            
            .popup .icon {
                margin-right: 0;
                margin-bottom: 0.5rem;
                width: auto;
            }
            
            .share-modal-content {
                padding: 1.5rem;
                max-width: 95vw;
            }
            
            .share-modal-title {
                font-size: 1.4rem;
            }
            
            .share-options {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .download-button {
                display: block;
                width: 100%;
                margin: 0 0 0.8rem 0;
            }
            
            .content-area {
                padding-bottom: 3rem; /* Space for footer */
            }


        }
        
        @media (max-width: 480px) {
            .controls {
                top: 0.25rem;
                left: 0.25rem;
                right: 0.25rem;
                width: calc(100vw - 0.5rem);
                padding: 0.5rem;
            }
            
            .legend {
                bottom: 4rem;
                left: 0.25rem;
                right: 0.25rem;
                padding: 0.5rem;
            }
            
            .title {
                font-size: 0.9rem;
            }
            
            .subtitle {
                font-size: 0.75rem;
            }
            
            .popup {
                padding: 1rem;
            }
            
            .share-modal-content {
                padding: 1rem;
            }
            
            .footer-content {
                font-size: 0.65rem;
                flex-direction: column;
                gap: 0.2rem;
                text-align: center;
            }
            
            .footer-separator {
                display: none;
            }
        }
        
        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.5rem;
            }
            
            .title {
                flex: 1 1 100%;
                text-align: center;
                margin-bottom: 0.5rem;
            }
            
            .subtitle {
                flex: 1 1 100%;
                margin-bottom: 0.5rem;
            }
            
            .control-group {
                flex: 1;
                min-width: 200px;
            }
            
            .share-button {
                flex: 1;
                min-width: 200px;
            }
            
            .legend {
                bottom: 2rem;
                max-height: 30vh;
                overflow-y: auto;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .legend-color {
                border-width: 0.5px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner">
        <div>🌍 Loading world data...</div>
        <div style="font-size: 1rem; margin-top: 0.5rem; opacity: 0.8;">Please wait while we prepare your visa explorer</div>
    </div>
    
    
    <div class="main-container">
        <div class="content-area">
            <div class="controls">
                <a href="index.html" class="back-link">
                    ← Back to Filter Tool
                </a>
                <div class="title">Nomad/Long Stay Visa Explorer</div>
                <div class="subtitle" id="filterHeadline">Explore Visa Duration Worldwide</div>
                <div class="filter-explanation" id="filterExplanation"></div>
                <div class="control-group">
                    <label for="filterSelect">View by:</label>
                    <select id="filterSelect"></select>
                </div>
                <button class="share-button" onclick="openShareModal()">
                    📱 Share This Map
                </button>
            </div>
            
            <div id="map"></div>
            
            <div class="legend" id="legendContainer"></div>
        </div>
        
        <footer class="footer">
            <div class="footer-content">
                <button onclick="openLegalModal('terms')" class="footer-link">Terms of Use</button>
                <span class="footer-separator">|</span>
                <button onclick="openLegalModal('privacy')" class="footer-link">Privacy Policy</button>
                <span class="footer-separator">|</span>
                <a href="https://www.nomadvisa.help/FAQs.html" class="footer-link">Visas FAQ</a>
                <span class="footer-separator">|</span>
                <a href="mailto:contact@nomadvisa.help" class="footer-link">Contact</a>
            </div>
            <div class="footer-copyright">
                © 2025 Digital Nomad Visa Matcher. Data updated monthly. Always verify requirements with official sources.
            </div>
        </footer>
    </div>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        
        
        // Legal content
        const legalContent = {
            terms: { 
                title: 'Terms of Use', 
                content: `<p>Welcome to our Digital Nomad Visa Matcher. By using this site, you agree to these terms. The information provided is for general informational purposes only and does not constitute legal advice. We strive to keep the information up-to-date, but we make no representations or warranties of any kind about the completeness, accuracy, or reliability of the information. Any reliance you place on such information is therefore strictly at your own risk. For any questions, please contact us at contact@nomadvisa.help.</p>` 
            },
            privacy: { 
                title: 'Privacy Policy', 
                content: `<p>This Privacy Policy describes how we handle your information. We use Google Analytics to collect anonymous data about website traffic to improve the user experience. This data is aggregated and does not personally identify you. We do not sell, trade, or otherwise transfer your personally identifiable information to outside parties. If you accept our cookie policy, you consent to our use of analytics. For any concerns, please contact us at contact@nomadvisa.help.</p>` 
            }
        };
        
        // Legal modal functions
        function openLegalModal(type) {
            const content = legalContent[type];
            if (!content) return;
            
            const modal = document.createElement('div');
            modal.className = 'legal-modal';
            modal.innerHTML = `
                <div class="legal-modal-content">
                    <div class="legal-modal-header">
                        <h2 class="legal-modal-title">${content.title}</h2>
                        <button class="close-modal" onclick="this.closest('.legal-modal').remove()">×</button>
                    </div>
                    <div class="legal-modal-body">
                        ${content.content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        const FILTERS = [
            // Standard Filters
            { path: 'visas[0].visa_length_months', text: 'Duration (Months)', type: 'normal', legendType: 'range', headline: 'Explore Visa Duration Worldwide', explanation: 'How long the visa lasts.', shortExplanation: 'Visa duration in months' },
            { path: 'visas[0].income_requirement_usd_month', text: 'Minimum Income (USD)', type: 'inverted', legendType: 'range', headline: 'Compare Income Requirements Globally', explanation: 'Required monthly earnings.', shortExplanation: 'Monthly income requirement' },
            { path: 'visas[0].visa_cost_usd', text: 'Visa Cost (USD)', type: 'inverted', legendType: 'range', headline: 'Discover Visa Costs Around the World', explanation: 'The application fee.', shortExplanation: 'Visa application cost' },
            { path: 'ratings.bureaucracy_level', text: 'Bureaucracy Level', type: 'inverted', legendType: 'adjective', headline: 'Navigate Bureaucracy Levels by Country', explanation: 'Difficulty of the process.', shortExplanation: 'Bureaucracy complexity' },
            { path: 'ratings.tax_friendliness', text: 'Tax Friendliness', type: 'normal', legendType: 'adjective', headline: 'Find Tax-Friendly Nomad Destinations', explanation: 'The overall tax burden.', shortExplanation: 'Tax burden level' },
            { path: 'ratings.social_security_liability', text: 'The Safety Net Cost', type: 'inverted', legendType: 'adjective', headline: 'Analyze Social Security Costs', explanation: 'Your required social contributions.', shortExplanation: 'Social security costs' },
            // Qualitative Filters
            { path: 'The Time Zone Tether', text: 'The Time Zone Tether', type: 'normal', legendType: 'adjective', headline: 'Rating for Time Zone Convenience', explanation: 'Global work schedule compatibility.', shortExplanation: 'Time zone compatibility', isQualitative: true },
            { path: 'The Third Place Ecosystem', text: 'The Third Place Ecosystem', type: 'normal', legendType: 'adjective', headline: 'Rating for Work-Friendly Spaces', explanation: 'Quality of cafes & coworking.', shortExplanation: 'Work-friendly spaces', isQualitative: true },
            { path: 'The Rhythm of Stay', text: 'The Rhythm of Stay', type: 'normal', legendType: 'adjective', headline: 'Rating for Long-Term Viability', explanation: 'Suitability for extended stays.', shortExplanation: 'Long-term suitability', isQualitative: true },
            { path: 'Navigating Corporate Apprehension', text: 'Navigating Corporate Apprehension', type: 'normal', legendType: 'adjective', headline: 'Rating for Corporate Risk', explanation: 'Geopolitical and legal stability.', shortExplanation: 'Corporate risk level', isQualitative: true },
            { path: 'The Architecture of Community', text: 'The Architecture of Community', type: 'normal', legendType: 'adjective', headline: 'Rating for Nomad Community Size', explanation: 'Presence of a nomad scene.', shortExplanation: 'Nomad community size', isQualitative: true },
            { path: 'Dating in a Transient World', text: 'Dating in a Transient World', type: 'normal', legendType: 'adjective', headline: 'Rating for Dating Scene', explanation: 'The local dating environment.', shortExplanation: 'Dating environment', isQualitative: true },
            { path: 'The Family Nomad Cohort', text: 'The Family Nomad Cohort', type: 'normal', legendType: 'adjective', headline: 'Rating for Family Friendliness', explanation: 'Suitability for nomad families.', shortExplanation: 'Family friendliness', isQualitative: true },
            { path: 'Niche Community Vibrancy', text: 'Niche Community Vibrancy', type: 'normal', legendType: 'adjective', headline: 'Rating for Niche Communities', explanation: 'Diversity of hobbyist groups.', shortExplanation: 'Niche community diversity', isQualitative: true },
            { path: 'Pet-Friendliness as a Litmus Test', text: 'Pet-Friendliness as a Litmus Test', type: 'normal', legendType: 'adjective', headline: 'Rating for Pet Friendliness', explanation: 'How welcome are pets.', shortExplanation: 'Pet friendliness', isQualitative: true },
            { path: 'Healthcare Accessibility & Reliability', text: 'Healthcare Accessibility & Reliability', type: 'normal', legendType: 'adjective', headline: 'Rating for Healthcare System', explanation: 'Quality of medical services.', shortExplanation: 'Healthcare quality', isQualitative: true },
            { path: 'The Vibe Quotient: Deconstructing Hype', text: 'The Vibe Quotient: Deconstructing Hype', type: 'normal', legendType: 'adjective', headline: 'Rating for Overall "Vibe"', explanation: 'Reality vs. popular perception.', shortExplanation: 'Overall vibe', isQualitative: true },
            { path: 'Kinetic Friendliness', text: 'Kinetic Friendliness', type: 'normal', legendType: 'adjective', headline: 'Rating for Local Transport', explanation: 'Ease of getting around.', shortExplanation: 'Local transport ease', isQualitative: true },
            { path: 'The Sensory Load', text: 'The Sensory Load', type: 'normal', legendType: 'adjective', headline: 'Rating for Sensory Environment', explanation: 'Noise, pollution, and cleanliness.', shortExplanation: 'Sensory environment', isQualitative: true },
            { path: 'Access to Restorative Environments', text: 'Access to Restorative Environments', type: 'normal', legendType: 'adjective', headline: 'Rating for Access to Nature', explanation: 'Proximity to natural escapes.', shortExplanation: 'Nature access', isQualitative: true },
            { path: 'The Friction of Life Admin', text: 'The Friction of Life Admin', type: 'normal', legendType: 'adjective', headline: 'Rating for Ease of Admin Tasks', explanation: 'Bureaucracy for daily life.', shortExplanation: 'Admin task ease', isQualitative: true },
            { path: 'The Ghost of Your Former Self', text: 'The Ghost of Your Former Self', type: 'normal', legendType: 'adjective', headline: 'Rating for Cultural Reinvention', explanation: 'Opportunities for personal growth.', shortExplanation: 'Personal growth', isQualitative: true },
            { path: 'The Baseline of Felt Safety', text: 'The Baseline of Felt Safety', type: 'normal', legendType: 'adjective', headline: 'Rating for Personal Safety', explanation: 'How safe you feel daily.', shortExplanation: 'Personal safety', isQualitative: true },
            { path: 'The Specter of Gentrification', text: 'The Specter of Gentrification', type: 'normal', legendType: 'adjective', headline: 'Rating for Nomad Impact', explanation: 'Nomad effect on local life.', shortExplanation: 'Nomad impact', isQualitative: true },
            { path: 'Navigating Passport Privilege', text: 'Navigating Passport Privilege', type: 'normal', legendType: 'adjective', headline: 'Rating for Global Awareness', explanation: 'Exposure to global inequalities.', shortExplanation: 'Global awareness', isQualitative: true },
            { path: 'The Minimalist\'s Reward', text: 'The Minimalist\'s Reward', type: 'normal', legendType: 'adjective', headline: 'Rating for Minimalism', explanation: 'Support for a minimalist lifestyle.', shortExplanation: 'Minimalist support', isQualitative: true },
            { path: 'The Path to Permanence', text: 'The Path to Permanence', type: 'normal', legendType: 'adjective', headline: 'Rating for Residency Path', explanation: 'Ease of becoming a resident.', shortExplanation: 'Residency ease', isQualitative: true }
        ];
        
        const COLOR_SCALE = ['#16a34a', '#86efac', '#facc15', '#fb923c', '#f87171'];
        const ADJECTIVES = ['Very Low', 'Low', 'Moderate', 'High', 'Very High'];
        const THRESHOLDS = {
            'visas[0].visa_length_months': [12, 24, 36, 48],
            'visas[0].income_requirement_usd_month': [446, 2023, 3601, 5178],
            'visas[0].visa_cost_usd': [100, 331, 660, 990]
        };
        
        function getNestedValue(obj, path) { 
            if (!path || !obj) return undefined; 
            return path.split('.').reduce((acc, part) => { 
                const match = part.match(/(\w+)\[(\d+)\]/); 
                if (match) { 
                    return acc && acc[match[1]] ? acc[match[1]][parseInt(match[2])] : undefined; 
                } 
                return acc ? acc[part] : undefined; 
            }, obj); 
        }
        
        function populateSelect(selectId, options) { 
            const select = document.getElementById(selectId); 
            select.innerHTML = ''; 
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.path;
                option.textContent = opt.text;
                select.appendChild(option);
            }); 
        }
        
        function updateFilterHeadline() {
            const currentFilter = document.getElementById('filterSelect').value;
            const filterDef = FILTERS.find(f => f.path === currentFilter);
            const headlineElement = document.getElementById('filterHeadline');
            const explanationElement = document.getElementById('filterExplanation');
            if (filterDef && filterDef.headline) {
                headlineElement.textContent = filterDef.headline;
                explanationElement.textContent = filterDef.explanation || '';
            }
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h2 style="color: #fca5a5; margin-bottom: 1rem;">⚠️ Error Loading Data</h2>
                <p>${message}</p>
                <p style="margin-top: 1rem; font-size: 0.9rem;">Please ensure you're running a local server and the data files are available.</p>
                <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    🔄 Retry
                </button>
            `;
            document.body.appendChild(errorDiv);
        }
        
        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.remove();
            }
        }
        
        populateSelect('filterSelect', FILTERS);
        updateFilterHeadline();
        
        // Responsive SVG setup
        function getViewportDimensions() {
            return {
                width: window.innerWidth,
                height: window.innerHeight - 80 // Account for footer
            };
        }
        
        const { width, height } = getViewportDimensions();
        
        const svg = d3.select('#map').append('svg')
            .attr('width', '100%')
            .attr('height', '100%')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('preserveAspectRatio', 'xMidYMid meet');
            
        const projection = d3.geoMercator()
            .scale(width / (2 * Math.PI) * 0.85)
            .translate([width / 2, height / 1.8]);
            
        const path = d3.geoPath().projection(projection);
        const g = svg.append("g");
        
        const zoom = d3.zoom()
            .scaleExtent([0.5, 10])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
                updateUrlParams(event.transform);
            });
            
        svg.call(zoom);
        
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
        
        // Handle window resize
        function handleResize() {
            const { width: newWidth, height: newHeight } = getViewportDimensions();
            
            svg.attr('viewBox', `0 0 ${newWidth} ${newHeight}`);
            
            projection
                .scale(newWidth / (2 * Math.PI) * 0.85)
                .translate([newWidth / 2, newHeight / 1.8]);
            
            g.selectAll('path').attr('d', path);
        }
        
        window.addEventListener('resize', debounce(handleResize, 250));
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function generateShareUrl() {
            const filter = document.getElementById('filterSelect').value;
            const transform = g.attr('transform') || 'translate(0,0) scale(1)';
            const params = new URLSearchParams({
                filter: filter,
                transform: transform
            });
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }
        
        function updateUrlParams(transform) {
            const filter = document.getElementById('filterSelect').value;
            const params = new URLSearchParams({
                filter: filter,
                transform: transform || 'translate(0,0) scale(1)'
            });
            window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
        }
        
        function applyUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const filter = params.get('filter');
            const transform = params.get('transform');
            
            if (filter && FILTERS.some(f => f.path === filter)) {
                document.getElementById('filterSelect').value = filter;
                currentFilter = filter;
                updateFilterHeadline();
            }
            
            if (transform && transform !== 'translate(0,0) scale(1)') {
                g.attr('transform', transform);
                const matches = transform.match(/translate\(([^,]+),([^)]+)\)\s*scale\(([^)]+)\)/);
                if (matches) {
                    const [, translateX, translateY, scale] = matches;
                    svg.call(zoom.transform, d3.zoomIdentity
                        .translate(+translateX, +translateY)
                        .scale(+scale));
                }
            }
        }
        
        function generateMapScreenshot() {
            return new Promise((resolve, reject) => {
                const shareButton = document.querySelector('.share-button');
                shareButton.classList.add('loading');
                shareButton.textContent = '📸 Generating...';
                
                // Create temporary container for screenshot with current state
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.top = '-9999px';
                tempContainer.style.left = '-9999px';
                tempContainer.style.width = '1200px';
                tempContainer.style.height = '800px';
                tempContainer.style.background = '#0f172a';
                document.body.appendChild(tempContainer);
                
                // Clone current map state
                const mapClone = document.getElementById('map').cloneNode(true);
                const controlsClone = document.querySelector('.controls').cloneNode(true);
                const legendClone = document.querySelector('.legend').cloneNode(true);
                
                // Set up cloned elements with exact current state
                mapClone.style.width = '1200px';
                mapClone.style.height = '800px';
                
                controlsClone.style.position = 'absolute';
                controlsClone.style.top = '20px';
                controlsClone.style.left = '20px';
                controlsClone.style.zIndex = '10';
                controlsClone.style.transform = 'none';
                
                legendClone.style.position = 'absolute';
                legendClone.style.top = '20px';
                legendClone.style.right = '20px';
                legendClone.style.zIndex = '10';
                legendClone.style.transform = 'none';
                
                // Remove interactive elements from clones
                const backLink = controlsClone.querySelector('.back-link');
                const shareBtn = controlsClone.querySelector('.share-button');
                if (backLink) backLink.remove();
                if (shareBtn) shareBtn.remove();
                
                tempContainer.appendChild(mapClone);
                tempContainer.appendChild(controlsClone);
                tempContainer.appendChild(legendClone);
                
                // Add current filter state branding
                const currentFilterText = FILTERS.find(f => f.path === document.getElementById('filterSelect').value)?.text || 'Global View';
                const brandingDiv = document.createElement('div');
                brandingDiv.style.position = 'absolute';
                brandingDiv.style.bottom = '20px';
                brandingDiv.style.left = '50%';
                brandingDiv.style.transform = 'translateX(-50%)';
                brandingDiv.style.textAlign = 'center';
                brandingDiv.style.color = '#e2e8f0';
                brandingDiv.style.fontFamily = 'Inter, sans-serif';
                brandingDiv.style.zIndex = '10';
                brandingDiv.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; background: rgba(15, 23, 42, 0.9); padding: 0.8rem 1.5rem; border-radius: 8px; border: 2px solid #38bdf8; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        🌍 Digital Nomad Visas: ${currentFilterText} | nomadvisa.help
                    </div>
                `;
                tempContainer.appendChild(brandingDiv);
                
                // Wait for rendering and capture
                setTimeout(() => {
                    html2canvas(tempContainer, {
                        backgroundColor: '#0f172a',
                        width: 1200,
                        height: 800,
                        scale: 1,
                        useCORS: true,
                        allowTaint: true,
                        logging: false
                    }).then(canvas => {
                        document.body.removeChild(tempContainer);
                        shareButton.classList.remove('loading');
                        shareButton.textContent = '📱 Share This Map';
                        resolve(canvas);
                    }).catch(error => {
                        document.body.removeChild(tempContainer);
                        shareButton.classList.remove('loading');
                        shareButton.textContent = '📱 Share This Map';
                        reject(error);
                    });
                }, 800);
            });
        }
        
        function openShareModal() {
            generateMapScreenshot().then(canvas => {
                const shareUrl = generateShareUrl();
                const filterText = FILTERS.find(f => f.path === document.getElementById('filterSelect').value).text;
                
                // Create dynamic share message based on current filter
                const shareMessages = {
                    'Duration (Months)': '🗓️ Discover which countries offer the longest digital nomad visas!',
                    'Minimum Income (USD)': '💰 Compare income requirements for nomad visas worldwide!',
                    'Visa Cost (USD)': '💳 Find the most affordable digital nomad visa destinations!',
                    'Bureaucracy Level': '📋 Navigate visa bureaucracy - find the easiest applications!',
                    'Tax Friendliness': '🏦 Explore tax-friendly destinations for digital nomads!',
                    'The Time Zone Tether': '🌐 Perfect time zones for remote work around the globe!',
                    'The Third Place Ecosystem': '☕ Best coworking and café scenes for nomads!',
                    'The Architecture of Community': '🤝 Thriving nomad communities worldwide!',
                    'Healthcare Accessibility & Reliability': '🏥 Healthcare quality for nomads by destination!',
                    'The Baseline of Felt Safety': '🛡️ Safety ratings for digital nomad destinations!'
                };
                
                const dynamicMessage = shareMessages[filterText] || '🌍 Exploring digital nomad visa options worldwide!';
                const shareText = `${dynamicMessage} Check out this interactive map showing ${filterText.toLowerCase()} across 190+ countries. Perfect tool for remote workers! #DigitalNomad #RemoteWork #VisaGuide`;
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'share-modal';
                modal.innerHTML = `
                    <div class="share-modal-content">
                        <div class="share-modal-header">
                            <h2 class="share-modal-title">🌍 Share Your Discovery</h2>
                            <button class="close-modal" onclick="this.closest('.share-modal').remove()">×</button>
                        </div>
                        
                        <div class="share-preview">
                            <canvas id="shareCanvas"></canvas>
                        </div>
                        
                        <div class="share-options">
                            <a href="#" class="share-option twitter" onclick="shareToTwitter('${encodeURIComponent(shareText)}', '${shareUrl}')">
                                <span class="share-icon">🐦</span>
                                <span class="share-text">Share on Twitter</span>
                            </a>
                            <a href="#" class="share-option facebook" onclick="shareToFacebook('${shareUrl}')">
                                <span class="share-icon">📘</span>
                                <span class="share-text">Share on Facebook</span>
                            </a>
                            <a href="#" class="share-option linkedin" onclick="shareToLinkedIn('${shareUrl}', '${encodeURIComponent(shareText)}')">
                                <span class="share-icon">💼</span>
                                <span class="share-text">Share on LinkedIn</span>
                            </a>
                            <a href="#" class="share-option reddit" onclick="shareToReddit('${shareUrl}', '${encodeURIComponent('Digital Nomad Visa Explorer - ' + filterText)}')">
                                <span class="share-icon">🤖</span>
                                <span class="share-text">Share on Reddit</span>
                            </a>
                            <a href="#" class="share-option whatsapp" onclick="shareToWhatsApp('${encodeURIComponent(shareText + ' ' + shareUrl)}')">
                                <span class="share-icon">💬</span>
                                <span class="share-text">Share on WhatsApp</span>
                            </a>
                            <a href="#" class="share-option telegram" onclick="shareToTelegram('${encodeURIComponent(shareText)}', '${shareUrl}')">
                                <span class="share-icon">✈️</span>
              _B_L_O_C_K_             <span class="share-text">Share on Telegram</span>
                            </a>
                        </div>
                        
                        <div class="download-section">
                            <button class="download-button" onclick="downloadImage()">
                                📁 Download PNG
                            </button>
                            <button class="download-button copy-url-button" onclick="copyShareUrl('${shareUrl}')">
                                🔗 Copy Link
                            </button>
                            <div class="share-url">${shareUrl}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add the canvas to the modal
                const shareCanvas = document.getElementById('shareCanvas');
                shareCanvas.width = canvas.width;
                shareCanvas.height = canvas.height;
                const ctx = shareCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0);
                
                // Store canvas globally for download
                window.currentShareCanvas = canvas;
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }).catch(error => {
                console.error('Failed to generate screenshot:', error);
                alert('❌ Failed to generate map preview. Please try again or check your browser permissions.');
            });
        }
        
        // Social media sharing functions
        function shareToTwitter(text, url) {
            const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}&hashtags=DigitalNomad,RemoteWork,VisaGuide`;
            window.open(twitterUrl, '_blank', 'width=600,height=400');
        }
        
        function shareToFacebook(url) {
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(facebookUrl, '_blank', 'width=600,height=400');
        }
        
        function shareToLinkedIn(url, text) {
            const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&summary=${text}`;
            window.open(linkedinUrl, '_blank', 'width=600,height=400');
        }
        
        function shareToReddit(url, text) {
            const redditUrl = `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${text}`;
            window.open(redditUrl, '_blank', 'width=600,height=400');
        }
        
        function shareToWhatsApp(text) {
            const whatsappUrl = `https://wa.me/?text=${text}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function shareToTelegram(text, url) {
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${text}`;
            window.open(telegramUrl, '_blank');
        }
        
        function downloadImage() {
            if (window.currentShareCanvas) {
                const filterText = FILTERS.find(f => f.path === document.getElementById('filterSelect').value).text;
                const filename = `nomad-visa-${filterText.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '')}-${Date.now()}.png`;
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = window.currentShareCanvas.toDataURL('image/png', 1.0);
                link.click();
            }
        }
        
        function copyShareUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.style.background = '#059669';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#374151';
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('🔗 URL copied to clipboard!');
            });
        }
        
        // Enhanced error handling for data loading
        let retryCount = 0;
        const maxRetries = 3;
        
        function loadDataWithRetry() {
            return new Promise((resolve, reject) => {
                const attemptLoad = () => {
                    Promise.all([
                        d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').catch(() => {
                            // Fallback to local topology if CDN fails
                            return d3.json('topology.json');
                        }),
                        d3.json('data/data.json')
                    ]).then(resolve).catch(error => {
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.warn(`Attempt ${retryCount} failed, retrying...`, error);
                            setTimeout(attemptLoad, 1000 * retryCount);
                        } else {
                            reject(error);
                        }
                    });
                };
                attemptLoad();
            });
        }
        
        // Main application initialization
        loadDataWithRetry().then(([topoData, visaDataRaw]) => {
            hideLoading();
            const visaData = visaDataRaw.slice(1);
            let currentFilter = FILTERS[0].path;
            
            const countryDataMap = new Map(visaData.map(d => [d.country_name, d]));
            const geoData = topojson.feature(topoData, topoData.objects.countries);
            
            const paths = g.selectAll('path')
                .data(geoData.features)
                .enter()
                .append('path')
                .attr('d', path)
                .on('click', showPopup)
                .on('mouseover', showTooltip)
                .on('mousemove', moveTooltip)
                .on('mouseout', hideTooltip);
            
            function updateStyles() {
                const filterDef = FILTERS.find(f => f.path === currentFilter);
                
                let colorScale;
                const colorRange = (filterDef.type === 'inverted') ? COLOR_SCALE : [...COLOR_SCALE].reverse();
                
                if (filterDef.legendType === 'range') {
                    colorScale = d3.scaleThreshold().domain(THRESHOLDS[currentFilter] || []).range(colorRange);
                } else {
                    const domain = [1, 5];
                    colorScale = d3.scaleQuantize().domain(domain).range(colorRange);
                }
                
                paths.transition().duration(750)
                    .style('transition-timing-function', 'ease-in-out')
                    .attr('fill', d => {
                        const country = countryDataMap.get(d.properties.name);
                        let value = null;
                        if (country) {
                            if (filterDef.isQualitative) {
                                const ratingObj = country.ratings[filterDef.path];
                                value = ratingObj ? ratingObj.score : null;
                            } else {
                                value = getNestedValue(country, currentFilter);
                            }
                        }
                        return value !== null && value !== undefined ? colorScale(value) : '#334155';
                    });
                
                updateLegend(colorScale, filterDef);
            }
            
            function showTooltip(event, d) { 
                const country = countryDataMap.get(d.properties.name);
                const tooltipText = country && country.visas && country.visas.length > 0 
                    ? `${d.properties.name} - Click for details` 
                    : `${d.properties.name} - No visa data`;
                    
                tooltip.transition().duration(200).style("opacity", .9); 
                tooltip.html(tooltipText)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px"); 
            }
            
            function moveTooltip(event) { 
                tooltip.style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px"); 
            }
            
            function hideTooltip() { 
                tooltip.transition().duration(500).style("opacity", 0); 
            }
            
            function showPopup(event, d) {
                hideTooltip();
                d3.selectAll('.popup-overlay').remove();
                
                const country = countryDataMap.get(d.properties.name);
                if (!country || !country.visas || country.visas.length === 0) {
                    const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
                    const popup = overlay.append('div').attr('class', 'popup');
                    popup.html(`
                        <div class="header">${d.properties.name}</div>
                        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                            <p>No digital nomad visa data available for this country.</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">Check back later for updates!</p>
                        </div>
                    `);
                    overlay.on('click', function() { d3.select(this).remove(); });
                    popup.on('click', (e) => e.stopPropagation());
                    return;
                }
                
                const visa = country.visas[0];
                let allQualitativeRatingsHtml = '';

                // Generate HTML for all qualitative ratings
                const qualitativeFilters = FILTERS.filter(f => f.isQualitative);
                if (qualitativeFilters.length > 0 && country.ratings) {
                    let ratingsContent = '';
                    qualitativeFilters.forEach(filterDef => {
                        const rating = country.ratings[filterDef.path];
                        if (rating && typeof rating.score !== 'undefined') {
                            const score = rating.score || 0;
                            const explanation = rating.explanation || 'No explanation available.';
                            const stars = '⭐'.repeat(score) + '☆'.repeat(Math.max(0, 5 - score));
                            
                            ratingsContent += `
                                <div class="qualitative-row">
                                    <div class="qualitative-title">
                                        <strong>${filterDef.text}</strong>
                                        <span class="qualitative-stars" title="Score: ${score}/5">${stars}</span>
                                    </div>
                                    <p class="qualitative-explanation">${explanation}</p>
                                </div>
                            `;
                        }
                    });
                    
                    if (ratingsContent) {
                        allQualitativeRatingsHtml = `
                            <div class="qualitative-ratings-header">Lifestyle & Qualitative Ratings</div>
                            ${ratingsContent}
                        `;
                    }
                }
                
                const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
                const popup = overlay.append('div').attr('class', 'popup');
                popup.html(`
                    <div class="header">${country.country_name}</div>
                    <p style="margin-bottom: 1.5rem; font-weight: 600; color: #38bdf8; text-align: center;">
                        <strong>Visa Program:</strong> ${visa.visa_name}
                    </p>
                    <div class="row">
                        <span class="icon">📅</span>
                        <div>
                            <strong>Duration:</strong> ${visa.visa_length_months || 'N/A'} months
                        </div>
                    </div>
                    <div class="row">
                        <span class="icon">💰</span>
                        <div>
                            <strong>Min Income:</strong> ${visa.income_requirement_usd_month ? `$${visa.income_requirement_usd_month.toLocaleString()}/month` : 'N/A'}
                        </div>
                    </div>
                    <div class="row">
                        <span class="icon">💳</span>
                        <div>
                            <strong>Visa Cost:</strong> ${visa.visa_cost_usd ? `$${visa.visa_cost_usd.toLocaleString()}` : 'N/A'}
                        </div>
                    </div>
                    ${visa.remarks ? `<p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1.5rem; padding: 1rem; background: rgba(56, 189, 248, 0.08); border-radius: 8px; border-left: 3px solid #38bdf8;"><strong>Notes:</strong> ${visa.remarks}</p>` : ''}
                    ${allQualitativeRatingsHtml}
                `);
                
                overlay.on('click', function() { d3.select(this).remove(); });
                popup.on('click', (e) => e.stopPropagation());
                updateUrlParams(g.attr('transform'));
            }
            
            function updateLegend(scale, filterDef) {
                const legendContainer = d3.select("#legendContainer");
                legendContainer.html('');
                legendContainer.append('div').attr('class', 'legend-title').text(filterDef.text);
                
                const legendItems = [];
                const colors = scale.range();
                
                if (filterDef.legendType === 'adjective') {
                    const adjectives = ADJECTIVES;
                    colors.forEach((color, i) => {
                        legendItems.push({ 
                            color: color, 
                            text: filterDef.type === 'inverted' ? adjectives[4-i] : adjectives[i]
                        });
                    });
                } else { 
                    const labels = [];
                    if (filterDef.path === 'visas[0].visa_length_months') { 
                        labels.push('3 - 11 months', '12 - 23 months', '24 - 35 months', '36 - 47 months', '48+ months'); 
                    } 
                    else if (filterDef.path === 'visas[0].income_requirement_usd_month') { 
                        labels.push('$0 - $445', '$446 - $2,022', '$2,023 - $3,600', '$3,601 - $5,177', '$5,178+'); 
                    } 
                    else if (filterDef.path === 'visas[0].visa_cost_usd') { 
                        labels.push('$0 - $99', '$100 - $330', '$331 - $659', '$660 - $989', '$990+'); 
                    }
                    
                    colors.forEach((color, i) => {
                        legendItems.push({ color: color, text: labels[i] });
                    });
                }
                
                if (filterDef.type === 'normal' && filterDef.legendType !== 'adjective') {
                    legendItems.reverse();
                }
                
                legendItems.forEach(item => {
                    const legendItem = d3.create('div').attr('class', 'legend-item');
                    legendItem.append('div').attr('class', 'legend-color').style('background-color', item.color);
                    legendItem.append('div').attr('class', 'legend-text').text(item.text);
                    legendContainer.node().appendChild(legendItem.node());
                });
            }
            
            d3.select('#filterSelect').on('change', function() { 
                currentFilter = this.value; 
                updateStyles(); 
                updateFilterHeadline();
                updateUrlParams(g.attr('transform')); 
            });
            
            // Apply URL parameters and initialize
            applyUrlParams();
            currentFilter = document.getElementById('filterSelect').value;
            updateStyles();
            
        }).catch(error => {
            hideLoading();
            console.error('Error loading data:', error);
            showError(`Could not load map data. ${error.message || 'Please check your internet connection and try again.'}`);
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('contextmenu', e => e.preventDefault());
    });
  </script>
</body>
</html>
