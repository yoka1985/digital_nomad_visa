<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomad/Long Stay Visa Explorer - Interactive World Map</title>
    
    <meta name="description" content="Explore digital nomad visa requirements worldwide with our interactive map. Compare visa duration, costs, income requirements, and bureaucracy levels for 190+ countries.">
    <meta name="keywords" content="digital nomad visa, remote work visa, nomad visa requirements, visa duration, visa cost, tax friendliness, bureaucracy level, world map, visa comparison">
    <meta name="author" content="Nomad/Long Stay Visa Explorer">
    <meta name="robots" content="index, follow">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/nomadvisa.help">
    <meta property="og:title" content="Nomad/Long Stay Visa Explorer - Interactive World Map">
    <meta property="og:description" content="Explore digital nomad visa requirements worldwide with our interactive map. Compare visa duration, costs, income requirements for 190+ countries.">
    <meta property="og:image" content="https://example.com/nomad-visa-preview.png">
    <meta property="og:site_name" content="Nomad/Long Stay Visa Explorer">
    
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://example.com/nomadvisa.help">
    <meta property="twitter:title" content="Nomad/Long Stay Visa Explorer - Interactive World Map">
    <meta property="twitter:description" content="Explore digital nomad visa requirements worldwide with our interactive map. Compare visa duration, costs, income requirements for 190+ countries.">
    <meta property="twitter:image" content="https://example.com/nomadvisa.png">
    
    <meta name="geo.region" content="Global">
    <meta name="geo.placename" content="Worldwide">
    <meta name="ICBM" content="0, 0">
    
    <link rel="canonical" href="https://example.com/nomadvisa.help">
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Nomad Visa Explorer",
        "description": "Interactive world map for exploring digital nomad visa requirements, costs, and bureaucracy levels across 190+ countries",
        "url": "https://example.com/nomadvisa.help",
        "applicationCategory": "Travel",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "Nomad/Long Stay Visa Explorer"
        }
    }
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6N573S8D8S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', { 'analytics_storage': 'denied' });
        function initGoogleAnalytics() {
            gtag('consent', 'update', { 'analytics_storage': 'granted' });
            gtag('js', new Date());
            gtag('config', 'G-6N573S8D8S');
            console.log("Google Analytics Initialized");
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: #e2e8f0; 
            overflow: hidden;
        }
        svg { 
            width: 100vw; 
            height: 100vh; 
            display: block; 
            background: #0f172a;
        }
        .controls { 
            position: absolute; 
            top: 0.5rem; 
            left: 0.5rem; 
            z-index: 10; 
            display: flex; 
            flex-direction: column; 
            gap: 0.8rem;
            background: rgba(15, 23, 42, 0.9);
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid #38bdf8;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(56, 189, 248, 0.2);
            max-width: 280px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        .title { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: #38bdf8; 
            text-shadow: 0 0 12px rgba(56, 189, 248, 0.6); 
            margin-bottom: 0.4rem;
            text-align: center;
        }
        .subtitle {
            font-size: 1rem;
            font-weight: 600;
            color: #facc15;
            text-align: center;
            margin-bottom: 0.8rem;
            padding: 0.4rem;
            background: rgba(250, 204, 21, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(250, 204, 21, 0.3);
        }
        .filter-explanation {
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: center;
            margin-bottom: 0.8rem;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #38bdf8;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .back-link:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: #38bdf8;
            transform: translateX(-2px);
        }
        label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #94a3b8;
        }
        select { 
            padding: 0.6rem; 
            font-size: 0.9rem; 
            font-weight: 500; 
            border-radius: 8px; 
            border: 2px solid #38bdf8; 
            background: #1e293b;
            color: #e2e8f0; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); 
            outline: none; 
            width: 100%;
            transition: all 0.3s ease;
        }
        select:focus {
            border-color: #facc15;
            box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.2);
        }
        .share-button {
            padding: 0.7rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            border: 2px solid #38bdf8;
            background: linear-gradient(135deg, #1e293b, #2563eb);
            color: #e2e8f0;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .share-button:hover {
            background: linear-gradient(135deg, #38bdf8, #06b6d4);
            color: #0f172a;
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(56, 189, 248, 0.4);
        }
        .share-button:active {
            transform: translateY(0);
        }
        .share-button.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .legend { 
            position: absolute; 
            top: 0.5rem; 
            right: 0.5rem; 
            background: rgba(15, 23, 42, 0.9);
            padding: 1rem; 
            border-radius: 10px; 
            box-shadow: 0 8px 32px rgba(56, 189, 248, 0.2); 
            z-index: 10; 
            border: 2px solid #38bdf8; 
            backdrop-filter: blur(10px);
            min-width: 200px;
            border-bottom: 3px solid #facc15;
        }
        .legend-title { 
            font-weight: 700; 
            color: #38bdf8; 
            margin-bottom: 0.8rem; 
            font-size: 1rem;
            text-align: center;
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 0.5rem; 
            padding: 0.3rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        .legend-item:hover {
            background: rgba(56, 189, 248, 0.1);
        }
        .legend-color { 
            width: 18px; 
            height: 18px; 
            margin-right: 10px; 
            border-radius: 4px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .legend-text { 
            font-size: 0.8rem; 
            font-weight: 500;
        }
        .tooltip { 
            position: absolute; 
            background: #1e293b; 
            padding: 0.6rem 1rem; 
            border-radius: 8px; 
            border: 2px solid #38bdf8; 
            color: #e2e8f0; 
            font-size: 0.9rem; 
            font-weight: 500;
            pointer-events: none; 
            z-index: 3000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1999;
            backdrop-filter: blur(6px);
        }
        .popup { 
            position: relative; 
            background: #1e293b; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(56, 189, 248, 0.4); 
            max-width: 90vw; 
            width: 480px; 
            font-size: 1rem; 
            color: #e2e8f0; 
            border: 2px solid #facc15; 
            max-height: 85vh;
            overflow-y: auto;
        }
        .popup .header { 
            font-size: 1.4rem; 
            font-weight: 700; 
            margin-bottom: 1.2rem; 
            color: #38bdf8;
            text-align: center;
            border-bottom: 1px solid #38bdf8;
            padding-bottom: 0.5rem;
        }
        .popup .row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 1rem; 
            padding: 0.5rem;
            background: rgba(56, 189, 248, 0.05);
            border-radius: 6px;
        }
        .popup .icon { 
            margin-right: 1rem; 
            font-size: 1.2rem; 
            width: 24px;
            text-align: center;
        }
        .qualitative-ratings-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #facc15;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #facc15;
        }
        .qualitative-row {
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            background: rgba(15, 23, 42, 0.7);
            border-left: 3px solid #64748b;
            border-radius: 6px;
        }
        .qualitative-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .qualitative-title strong {
            color: #94a3b8;
            font-size: 0.95rem;
        }
        .qualitative-stars {
            font-size: 1.1rem;
            color: #facc15;
        }
        .qualitative-explanation {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin: 0;
            line-height: 1.5;
        }
        path { 
            stroke: #0f172a; 
            stroke-width: 0.5; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        path:hover { 
            fill-opacity: 0.8; 
            stroke-width: 1.5;
            stroke: #38bdf8;
        }
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }
        .share-modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #38bdf8;
            box-shadow: 0 25px 80px rgba(56, 189, 248, 0.3);
        }
        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #38bdf8;
            padding-bottom: 1rem;
        }
        .share-modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #38bdf8;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            transform: rotate(90deg);
        }
        .share-preview {
            text-align: center;
            margin-bottom: 2rem;
        }
        .share-preview canvas {
            max-width: 100%;
            border-radius: 12px;
            border: 2px solid #38bdf8;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .share-option {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            background: linear-gradient(135deg, #334155, #475569);
            border: 2px solid #64748b;
            border-radius: 12px;
            color: #e2e8f0;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }
        .share-option:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border-color: #38bdf8;
        }
        .share-option.twitter:hover { background: linear-gradient(135deg, #1da1f2, #0d8bd9); }
        .share-option.facebook:hover { background: linear-gradient(135deg, #1877f2, #166fe5); }
        .share-option.linkedin:hover { background: linear-gradient(135deg, #0077b5, #005885); }
        .share-option.reddit:hover { background: linear-gradient(135deg, #ff4500, #e03d00); }
        .share-option.whatsapp:hover { background: linear-gradient(135deg, #25d366, #1da851); }
        .share-option.telegram:hover { background: linear-gradient(135deg, #0088cc, #006699); }
        
        .share-icon {
            font-size: 1.6rem;
            margin-right: 1rem;
        }
        .share-text {
            font-weight: 600;
        }
        .download-section {
            border-top: 2px solid #38bdf8;
            padding-top: 2rem;
            text-align: center;
        }
        .download-button {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 0.5rem;
            font-size: 1rem;
        }
        .download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
        }
        .share-url {
            background: #334155;
            border: 2px solid #64748b;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            color: #e2e8f0;
        }
        .copy-url-button {
            background: #374151;
            color: #e2e8f0;
            border: 2px solid #64748b;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .copy-url-button:hover {
            background: #38bdf8;
            color: #0f172a;
            border-color: #38bdf8;
            transform: translateY(-2px);
        }
        
        /* Error handling styles */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #7f1d1d;
            color: #fca5a5;
            padding: 2rem;
            border-radius: 12px;
            border: 2px solid #dc2626;
            text-align: center;
            z-index: 10000;
            max-width: 90vw;
            width: 500px;
        }
        
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #38bdf8;
            font-size: 2rem;
            z-index: 9999;
        }
        
        @media (max-width: 768px) {
            .controls {
                max-width: 240px;
                padding: 0.8rem;
            }
            .title {
                font-size: 1.2rem;
            }
            .subtitle {
                font-size: 0.9rem;
            }
            .legend {
                min-width: 180px;
                padding: 0.8rem;
            }
            .share-modal-content {
                padding: 1.5rem;
            }
            .share-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner">üåç Loading world data...</div>
    
    <div class="controls">
        <a href="index.html" class="back-link">
            ‚Üê Back to Filter Tool
        </a>
        <div class="title">Nomad/Long Stay Visa Explorer</div>
        <div class="subtitle" id="filterHeadline">Explore Visa Duration Worldwide</div>
        <div class="filter-explanation" id="filterExplanation"></div>
        <div class="control-group">
            <label for="nationalitySelect">Your Nationality:</label>
            <select id="nationalitySelect"></select>
        </div>
        <div class="control-group">
            <label for="filterSelect">View by:</label>
            <select id="filterSelect"></select>
        </div>
        <button class="share-button" onclick="openShareModal()">
            üì± Share on Social Media
        </button>
    </div>
    <div id="map"></div>
    <div class="legend" id="legendContainer"></div>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        initGoogleAnalytics();
        const POPULAR_COUNTRIES = ['USA', 'United Kingdom', 'Canada', 'Germany', 'Australia', 'France', 'India', 'Brazil', 'China', 'Russia', 'Spain', 'Italy', 'Netherlands', 'Sweden', 'Switzerland', 'Ireland', 'Israel', 'South Africa', 'Argentina', 'Mexico'];
        const ALL_NATIONALITIES = [ "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo, Democratic Republic of the", "Congo, Republic of the", "Costa Rica", "Cote d'Ivoire", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "USA", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe" ];
        const EU_COUNTRIES = ['Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden'];
        
        const FILTERS = [
            // Standard Filters
            { path: 'visas[0].visa_length_months', text: 'Duration (Months)', type: 'normal', legendType: 'range', headline: 'Explore Visa Duration Worldwide', explanation: 'How long the visa lasts.', shortExplanation: 'Visa duration in months' },
            { path: 'visas[0].income_requirement_usd_month', text: 'Minimum Income (USD)', type: 'inverted', legendType: 'range', headline: 'Compare Income Requirements Globally', explanation: 'Required monthly earnings.', shortExplanation: 'Monthly income requirement' },
            { path: 'visas[0].visa_cost_usd', text: 'Visa Cost (USD)', type: 'inverted', legendType: 'range', headline: 'Discover Visa Costs Around the World', explanation: 'The application fee.', shortExplanation: 'Visa application cost' },
            { path: 'ratings.bureaucracy_level', text: 'Bureaucracy Level', type: 'inverted', legendType: 'adjective', headline: 'Navigate Bureaucracy Levels by Country', explanation: 'Difficulty of the process.', shortExplanation: 'Bureaucracy complexity' },
            { path: 'ratings.tax_friendliness', text: 'Tax Friendliness', type: 'normal', legendType: 'adjective', headline: 'Find Tax-Friendly Nomad Destinations', explanation: 'The overall tax burden.', shortExplanation: 'Tax burden level' },
            { path: 'ratings.social_security_liability', text: 'The Safety Net Cost', type: 'inverted', legendType: 'adjective', headline: 'Analyze Social Security Costs', explanation: 'Your required social contributions.', shortExplanation: 'Social security costs' },
            // Qualitative Filters
            { path: 'The Time Zone Tether', text: 'The Time Zone Tether', type: 'normal', legendType: 'adjective', headline: 'Rating for Time Zone Convenience', explanation: 'Global work schedule compatibility.', shortExplanation: 'Time zone compatibility', isQualitative: true },
            { path: 'The Third Place Ecosystem', text: 'The Third Place Ecosystem', type: 'normal', legendType: 'adjective', headline: 'Rating for Work-Friendly Spaces', explanation: 'Quality of cafes & coworking.', shortExplanation: 'Work-friendly spaces', isQualitative: true },
            { path: 'The Rhythm of Stay', text: 'The Rhythm of Stay', type: 'normal', legendType: 'adjective', headline: 'Rating for Long-Term Viability', explanation: 'Suitability for extended stays.', shortExplanation: 'Long-term suitability', isQualitative: true },
            { path: 'Navigating Corporate Apprehension', text: 'Navigating Corporate Apprehension', type: 'normal', legendType: 'adjective', headline: 'Rating for Corporate Risk', explanation: 'Geopolitical and legal stability.', shortExplanation: 'Corporate risk level', isQualitative: true },
            { path: 'The Architecture of Community', text: 'The Architecture of Community', type: 'normal', legendType: 'adjective', headline: 'Rating for Nomad Community Size', explanation: 'Presence of a nomad scene.', shortExplanation: 'Nomad community size', isQualitative: true },
            { path: 'Dating in a Transient World', text: 'Dating in a Transient World', type: 'normal', legendType: 'adjective', headline: 'Rating for Dating Scene', explanation: 'The local dating environment.', shortExplanation: 'Dating environment', isQualitative: true },
            { path: 'The Family Nomad Cohort', text: 'The Family Nomad Cohort', type: 'normal', legendType: 'adjective', headline: 'Rating for Family Friendliness', explanation: 'Suitability for nomad families.', shortExplanation: 'Family friendliness', isQualitative: true },
            { path: 'Niche Community Vibrancy', text: 'Niche Community Vibrancy', type: 'normal', legendType: 'adjective', headline: 'Rating for Niche Communities', explanation: 'Diversity of hobbyist groups.', shortExplanation: 'Niche community diversity', isQualitative: true },
            { path: 'Pet-Friendliness as a Litmus Test', text: 'Pet-Friendliness as a Litmus Test', type: 'normal', legendType: 'adjective', headline: 'Rating for Pet Friendliness', explanation: 'How welcome are pets.', shortExplanation: 'Pet friendliness', isQualitative: true },
            { path: 'Healthcare Accessibility & Reliability', text: 'Healthcare Accessibility & Reliability', type: 'normal', legendType: 'adjective', headline: 'Rating for Healthcare System', explanation: 'Quality of medical services.', shortExplanation: 'Healthcare quality', isQualitative: true },
            { path: 'The Vibe Quotient: Deconstructing Hype', text: 'The Vibe Quotient: Deconstructing Hype', type: 'normal', legendType: 'adjective', headline: 'Rating for Overall "Vibe"', explanation: 'Reality vs. popular perception.', shortExplanation: 'Overall vibe', isQualitative: true },
            { path: 'Kinetic Friendliness', text: 'Kinetic Friendliness', type: 'normal', legendType: 'adjective', headline: 'Rating for Local Transport', explanation: 'Ease of getting around.', shortExplanation: 'Local transport ease', isQualitative: true },
            { path: 'The Sensory Load', text: 'The Sensory Load', type: 'normal', legendType: 'adjective', headline: 'Rating for Sensory Environment', explanation: 'Noise, pollution, and cleanliness.', shortExplanation: 'Sensory environment', isQualitative: true },
            { path: 'Access to Restorative Environments', text: 'Access to Restorative Environments', type: 'normal', legendType: 'adjective', headline: 'Rating for Access to Nature', explanation: 'Proximity to natural escapes.', shortExplanation: 'Nature access', isQualitative: true },
            { path: 'The Friction of Life Admin', text: 'The Friction of Life Admin', type: 'normal', legendType: 'adjective', headline: 'Rating for Ease of Admin Tasks', explanation: 'Bureaucracy for daily life.', shortExplanation: 'Admin task ease', isQualitative: true },
            { path: 'The Ghost of Your Former Self', text: 'The Ghost of Your Former Self', type: 'normal', legendType: 'adjective', headline: 'Rating for Cultural Reinvention', explanation: 'Opportunities for personal growth.', shortExplanation: 'Personal growth', isQualitative: true },
            { path: 'The Baseline of Felt Safety', text: 'The Baseline of Felt Safety', type: 'normal', legendType: 'adjective', headline: 'Rating for Personal Safety', explanation: 'How safe you feel daily.', shortExplanation: 'Personal safety', isQualitative: true },
            { path: 'The Specter of Gentrification', text: 'The Specter of Gentrification', type: 'normal', legendType: 'adjective', headline: 'Rating for Nomad Impact', explanation: 'Nomad effect on local life.', shortExplanation: 'Nomad impact', isQualitative: true },
            { path: 'Navigating Passport Privilege', text: 'Navigating Passport Privilege', type: 'normal', legendType: 'adjective', headline: 'Rating for Global Awareness', explanation: 'Exposure to global inequalities.', shortExplanation: 'Global awareness', isQualitative: true },
            { path: 'The Minimalist\'s Reward', text: 'The Minimalist\'s Reward', type: 'normal', legendType: 'adjective', headline: 'Rating for Minimalism', explanation: 'Support for a minimalist lifestyle.', shortExplanation: 'Minimalist support', isQualitative: true },
            { path: 'The Path to Permanence', text: 'The Path to Permanence', type: 'normal', legendType: 'adjective', headline: 'Rating for Residency Path', explanation: 'Ease of becoming a resident.', shortExplanation: 'Residency ease', isQualitative: true }
        ];
        const COLOR_SCALE = ['#16a34a', '#86efac', '#facc15', '#fb923c', '#f87171'];
        const ADJECTIVES = ['Very Low', 'Low', 'Moderate', 'High', 'Very High'];
        const THRESHOLDS = {
            'visas[0].visa_length_months': [12, 24, 36, 48],
            'visas[0].income_requirement_usd_month': [446, 2023, 3601, 5178],
            'visas[0].visa_cost_usd': [100, 331, 660, 990]
        };
        
        function getNestedValue(obj, path) { 
            if (!path || !obj) return undefined; 
            return path.split('.').reduce((acc, part) => { 
                const match = part.match(/(\w+)\[(\d+)\]/); 
                if (match) { 
                    return acc && acc[match[1]] ? acc[match[1]][parseInt(match[2])] : undefined; 
                } 
                return acc ? acc[part] : undefined; 
            }, obj); 
        }
        
        function populateSelect(selectId, options, isGrouped = false) { 
            const select = document.getElementById(selectId); 
            select.innerHTML = ''; 
            if(isGrouped) { 
                const popularGroup = document.createElement('optgroup'); 
                popularGroup.label = 'Popular Nationalities'; 
                options.popular.forEach(text => popularGroup.appendChild(new Option(text, text))); 
                select.appendChild(popularGroup); 
                const otherGroup = document.createElement('optgroup'); 
                otherGroup.label = 'All Nationalities'; 
                options.other.forEach(text => otherGroup.appendChild(new Option(text, text))); 
                select.appendChild(otherGroup); 
            } else { 
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.path;
                    option.textContent = opt.text;
                    select.appendChild(option);
                }); 
            } 
        }
        
        function updateFilterHeadline() {
            const currentFilter = document.getElementById('filterSelect').value;
            const filterDef = FILTERS.find(f => f.path === currentFilter);
            const headlineElement = document.getElementById('filterHeadline');
            const explanationElement = document.getElementById('filterExplanation');
            if (filterDef && filterDef.headline) {
                headlineElement.textContent = filterDef.headline;
                explanationElement.textContent = filterDef.explanation || '';
            }
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h2 style="color: #fca5a5; margin-bottom: 1rem;">‚ö†Ô∏è Error Loading Data</h2>
                <p>${message}</p>
                <p style="margin-top: 1rem; font-size: 0.9rem;">Please ensure you're running a local server and the data files are available.</p>
                <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üîÑ Retry
                </button>
            `;
            document.body.appendChild(errorDiv);
        }
        
        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.remove();
            }
        }
        
        const otherCountries = ALL_NATIONALITIES.filter(c => !POPULAR_COUNTRIES.includes(c)).sort();
        populateSelect('nationalitySelect', { popular: POPULAR_COUNTRIES, other: otherCountries }, true);
        document.getElementById('nationalitySelect').value = 'USA';
        populateSelect('filterSelect', FILTERS);
        updateFilterHeadline();
        const width = window.innerWidth;
        const height = window.innerHeight;
        const svg = d3.select('#map').append('svg').attr('width', width).attr('height', height);
        const projection = d3.geoMercator().scale(width / (2 * Math.PI) * 0.9).translate([width / 2, height / 1.7]);
        const path = d3.geoPath().projection(projection);
        const g = svg.append("g");
        const zoom = d3.zoom().scaleExtent([1, 10]).on('zoom', (event) => {
            g.attr('transform', event.transform);
            updateUrlParams(event.transform);
        });
        svg.call(zoom);
        const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);
        function generateShareUrl() {
            const nationality = document.getElementById('nationalitySelect').value;
            const filter = document.getElementById('filterSelect').value;
            const transform = g.attr('transform');
            const params = new URLSearchParams({
                nationality: nationality,
                filter: filter,
                transform: transform
            });
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }
        function updateUrlParams(transform) {
            const nationality = document.getElementById('nationalitySelect').value;
            const filter = document.getElementById('filterSelect').value;
            const params = new URLSearchParams({
                nationality: nationality,
                filter: filter,
                transform: transform
            });
            window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
        }
        function applyUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const nationality = params.get('nationality');
            const filter = params.get('filter');
            const transform = params.get('transform');
            if (nationality && ALL_NATIONALITIES.includes(nationality)) {
                document.getElementById('nationalitySelect').value = nationality;
                currentNationality = nationality;
            }
            if (filter && FILTERS.some(f => f.path === filter)) {
                document.getElementById('filterSelect').value = filter;
                currentFilter = filter;
                updateFilterHeadline();
            }
            if (transform) {
                g.attr('transform', transform);
                const matches = transform.match(/translate\(([^,]+),([^)]+)\)\s*scale\(([^)]+)\)/);
                if (matches) {
                    const [, translateX, translateY, scale] = matches;
                    svg.call(zoom.transform, d3.zoomIdentity.translate(+translateX, +translateY).scale(+scale));
                }
            }
        }
        function generateMapScreenshot() {
            return new Promise((resolve, reject) => {
                const shareButton = document.querySelector('.share-button');
                shareButton.classList.add('loading');
                shareButton.textContent = 'üì∏ Generating...';
                // Create temporary container for screenshot
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.top = '-9999px';
                tempContainer.style.left = '-9999px';
                tempContainer.style.width = '1200px';
                tempContainer.style.height = '800px';
                tempContainer.style.background = '#0f172a';
                document.body.appendChild(tempContainer);
                // Clone and style elements
                const mapClone = document.getElementById('map').cloneNode(true);
                const controlsClone = document.querySelector('.controls').cloneNode(true);
                const legendClone = document.querySelector('.legend').cloneNode(true);
                // Set up cloned elements
                mapClone.style.width = '1200px';
                mapClone.style.height = '800px';
                controlsClone.style.position = 'absolute';
                controlsClone.style.top = '20px';
                controlsClone.style.left = '20px';
                controlsClone.style.zIndex = '10';
                legendClone.style.position = 'absolute';
                legendClone.style.top = '20px';
                legendClone.style.right = '20px';
                legendClone.style.zIndex = '10';
                tempContainer.appendChild(mapClone);
                tempContainer.appendChild(controlsClone);
                tempContainer.appendChild(legendClone);
                // Add branding
                const brandingDiv = document.createElement('div');
                brandingDiv.style.position = 'absolute';
                brandingDiv.style.bottom = '20px';
                brandingDiv.style.left = '50%';
                brandingDiv.style.transform = 'translateX(-50%)';
                brandingDiv.style.textAlign = 'center';
                brandingDiv.style.color = '#e2e8f0';
                brandingDiv.style.fontFamily = 'Inter, sans-serif';
                brandingDiv.style.zIndex = '10';
                brandingDiv.innerHTML = `
                    <div style="font-size: 14px; opacity: 0.8; background: rgba(15, 23, 42, 0.8); padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #38bdf8;">
                        üåç Nomad/Long Stay Visa Explorer - nomadvisa.help
                    </div>
                `;
                tempContainer.appendChild(brandingDiv);
                // Wait a moment for rendering
                setTimeout(() => {
                    html2canvas(tempContainer, {
                        backgroundColor: '#0f172a',
                        width: 1200,
                        height: 800,
                        scale: 1,
                        useCORS: true,
                        allowTaint: true
                    }).then(canvas => {
                        document.body.removeChild(tempContainer);
                        shareButton.classList.remove('loading');
                        shareButton.textContent = 'üì± Share on Social Media';
                        resolve(canvas);
                    }).catch(error => {
                        document.body.removeChild(tempContainer);
                        shareButton.classList.remove('loading');
                        shareButton.textContent = 'üì± Share on Social Media';
                        reject(error);
                    });
                }, 500);
            });
        }
        function openShareModal() {
            generateMapScreenshot().then(canvas => {
                const shareUrl = generateShareUrl();
                const nationality = document.getElementById('nationalitySelect').value;
                const filterText = FILTERS.find(f => f.path === document.getElementById('filterSelect').value).text;
                
                const shareText = `üåç Exploring digital nomad visa options for ${nationality} citizens! Check out this interactive map showing ${filterText.toLowerCase()} across 190+ countries. Perfect for remote workers and digital nomads! #DigitalNomad #RemoteWork #VisaGuide`;
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'share-modal';
                modal.innerHTML = `
                    <div class="share-modal-content">
                        <div class="share-modal-header">
                            <h2 class="share-modal-title">üåç Share Your Nomad Map</h2>
                            <button class="close-modal" onclick="this.closest('.share-modal').remove()">√ó</button>
                        </div>
                        
                        <div class="share-preview">
                            <canvas id="shareCanvas"></canvas>
                        </div>
                        
                        <div class="share-options">
                            <a href="#" class="share-option twitter" onclick="shareToTwitter('${encodeURIComponent(shareText)}', '${shareUrl}')">
                                <span class="share-icon">üê¶</span>
                                <span class="share-text">Share on Twitter</span>
                            </a>
                            <a href="#" class="share-option facebook" onclick="shareToFacebook('${shareUrl}')">
                                <span class="share-icon">üìò</span>
                                <span class="share-text">Share on Facebook</span>
                            </a>
                            <a href="#" class="share-option linkedin" onclick="shareToLinkedIn('${shareUrl}', '${encodeURIComponent(shareText)}')">
                                <span class="share-icon">üíº</span>
                                <span class="share-text">Share on LinkedIn</span>
                            </a>
                            <a href="#" class="share-option reddit" onclick="shareToReddit('${shareUrl}', '${encodeURIComponent('Nomad/Long Stay Visa Explorer - Interactive World Map')}')">
                                <span class="share-icon">ü§ñ</span>
                                <span class="share-text">Share on Reddit</span>
                            </a>
                            <a href="#" class="share-option whatsapp" onclick="shareToWhatsApp('${encodeURIComponent(shareText + ' ' + shareUrl)}')">
                                <span class="share-icon">üí¨</span>
                                <span class="share-text">Share on WhatsApp</span>
                            </a>
                            <a href="#" class="share-option telegram" onclick="shareToTelegram('${encodeURIComponent(shareText)}', '${shareUrl}')">
                                <span class="share-icon">‚úàÔ∏è</span>
                                <span class="share-text">Share on Telegram</span>
                            </a>
                        </div>
                        
                        <div class="download-section">
                            <button class="download-button" onclick="downloadImage()">
                                üìÅ Download PNG
                            </button>
                            <button class="download-button copy-url-button" onclick="copyShareUrl('${shareUrl}')">
                                üîó Copy Link
                            </button>
                            <div class="share-url">${shareUrl}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add the canvas to the modal
                const shareCanvas = document.getElementById('shareCanvas');
                shareCanvas.width = canvas.width;
                shareCanvas.height = canvas.height;
                const ctx = shareCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0);
                
                // Store canvas globally for download
                window.currentShareCanvas = canvas;
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }).catch(error => {
                console.error('Failed to generate screenshot:', error);
                alert('‚ùå Failed to generate map preview. Please try again or check your browser permissions.');
            });
        }
        // Social media sharing functions
        function shareToTwitter(text, url) {
            const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}&hashtags=DigitalNomad,RemoteWork,VisaGuide`;
            window.open(twitterUrl, '_blank', 'width=600,height=400');
        }
        function shareToFacebook(url) {
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(facebookUrl, '_blank', 'width=600,height=400');
        }
        function shareToLinkedIn(url, text) {
            const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&summary=${text}`;
            window.open(linkedinUrl, '_blank', 'width=600,height=400');
        }
        function shareToReddit(url, text) {
            const redditUrl = `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${text}`;
            window.open(redditUrl, '_blank', 'width=600,height=400');
        }
        function shareToWhatsApp(text) {
            const whatsappUrl = `https://wa.me/?text=${text}`;
            window.open(whatsappUrl, '_blank');
        }
        function shareToTelegram(text, url) {
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${text}`;
            window.open(telegramUrl, '_blank');
        }
        function downloadImage() {
            if (window.currentShareCanvas) {
                const nationality = document.getElementById('nationalitySelect').value;
                const filterText = FILTERS.find(f => f.path === document.getElementById('filterSelect').value).text;
                const filename = `nomad-visa-${nationality.toLowerCase().replace(/\s+/g, '-')}-${filterText.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}.png`;
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = window.currentShareCanvas.toDataURL('image/png', 1.0);
                link.click();
            }
        }
        function copyShareUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#059669';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#374151';
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('üîó URL copied to clipboard!');
            });
        }
        // Enhanced error handling for data loading
        let retryCount = 0;
        const maxRetries = 3;
        function loadDataWithRetry() {
            return new Promise((resolve, reject) => {
                const attemptLoad = () => {
                    Promise.all([
                        d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').catch(() => {
                            // Fallback to local topology if CDN fails
                            return d3.json('topology.json');
                        }),
                        d3.json('data/data.json')
                    ]).then(resolve).catch(error => {
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.warn(`Attempt ${retryCount} failed, retrying...`, error);
                            setTimeout(attemptLoad, 1000 * retryCount);
                        } else {
                            reject(error);
                        }
                    });
                };
                attemptLoad();
            });
        }
        // Main application initialization
        loadDataWithRetry().then(([topoData, visaDataRaw]) => {
            hideLoading();
            const visaData = visaDataRaw.slice(1);
            let currentFilter = FILTERS[0].path;
            let currentNationality = 'USA';
            const countryDataMap = new Map(visaData.map(d => [d.country_name, d]));
            const geoData = topojson.feature(topoData, topoData.objects.countries);
            const paths = g.selectAll('path').data(geoData.features).enter().append('path')
                .attr('d', path)
                .on('click', showPopup)
                .on('mouseover', showTooltip)
                .on('mousemove', moveTooltip)
                .on('mouseout', hideTooltip);
            function updateStyles() {
                const filterDef = FILTERS.find(f => f.path === currentFilter);
                
                let colorScale;
                const colorRange = (filterDef.type === 'inverted') ? COLOR_SCALE : [...COLOR_SCALE].reverse();
                
                if (filterDef.legendType === 'range') {
                    colorScale = d3.scaleThreshold().domain(THRESHOLDS[currentFilter] || []).range(colorRange);
                } else {
                    const domain = [1, 5];
                    colorScale = d3.scaleQuantize().domain(domain).range(colorRange);
                }
                paths.transition().duration(750)
                    .style('transition-timing-function', 'ease-in-out')
                    .attr('fill', d => {
                        const country = countryDataMap.get(d.properties.name);
                        let value = null;
                        if (country) {
                            if (filterDef.isQualitative) {
                                const ratingObj = country.ratings[filterDef.path];
                                value = ratingObj ? ratingObj.score : null;
                            } else {
                                value = getNestedValue(country, currentFilter);
                            }
                        }
                        return value !== null && value !== undefined ? colorScale(value) : '#334155';
                    });
                updateLegend(colorScale, filterDef);
            }
            
            function showTooltip(event, d) { 
                const country = countryDataMap.get(d.properties.name);
                const tooltipText = country && country.visas && country.visas.length > 0 
                    ? `${d.properties.name} - Click for details` 
                    : `${d.properties.name} - No visa data`;
                    
                tooltip.transition().duration(200).style("opacity", .9); 
                tooltip.html(tooltipText)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px"); 
            }
            function moveTooltip(event) { 
                tooltip.style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px"); 
            }
            function hideTooltip() { 
                tooltip.transition().duration(500).style("opacity", 0); 
            }
            function showPopup(event, d) {
                hideTooltip();
                d3.selectAll('.popup-overlay').remove();
                const country = countryDataMap.get(d.properties.name);
                if (!country || !country.visas || country.visas.length === 0) {
                    const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
                    const popup = overlay.append('div').attr('class', 'popup');
                    popup.html(`
                        <div class="header">${d.properties.name}</div>
                        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                            <p>No digital nomad visa data available for this country.</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">Check back later for updates!</p>
                        </div>
                    `);
                    overlay.on('click', function() { d3.select(this).remove(); });
                    popup.on('click', (e) => e.stopPropagation());
                    return;
                }
                
                const visa = country.visas[0];
                let eligibilityText = "‚ö†Ô∏è Check Eligibility";
                let eligibilityColor = "#facc15";
                
                if (visa.eligible_citizens_cluster === "All Nationalities") {
                    eligibilityText = "‚úÖ Eligible";
                    eligibilityColor = "#16a34a";
                } else if (visa.eligible_citizens_cluster === "Non-EU/EEA Nationals" && !EU_COUNTRIES.includes(currentNationality)) {
                    eligibilityText = "‚úÖ Eligible";
                    eligibilityColor = "#16a34a";
                } else if (EU_COUNTRIES.includes(currentNationality) && EU_COUNTRIES.includes(country.country_name)) {
                    eligibilityText = "‚úÖ Eligible (Freedom of Movement)";
                    eligibilityColor = "#16a34a";
                } else {
                    eligibilityText = "‚ö†Ô∏è Check Requirements";
                    eligibilityColor = "#fb923c";
                }
                const filterDef = FILTERS.find(f => f.path === currentFilter);
                let qualitativeRatingHtml = '';
                if (filterDef.isQualitative && country.ratings && country.ratings[filterDef.path]) {
                    const rating = country.ratings[filterDef.path];
                    const score = rating.score || 0;
                    const explanation = rating.explanation || 'No explanation available.';
                    const stars = '‚≠ê'.repeat(score) + '‚òÜ'.repeat(Math.max(0, 5 - score));
                    qualitativeRatingHtml = `
                        <div class="qualitative-row">
                            <div class="qualitative-title">
                                <strong>${filterDef.text}</strong>
                                <span class="qualitative-stars" title="Score: ${score}/5">${stars}</span>
                            </div>
                            <p class="qualitative-explanation">${explanation}</p>
                        </div>
                    `;
                }
                
                const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
                const popup = overlay.append('div').attr('class', 'popup');
                popup.html(`
                    <div class="header">${country.country_name}</div>
                    <p style="margin-bottom: 1.2rem; font-weight: 600; color: #38bdf8;"><strong>Visa Program:</strong> ${visa.visa_name}</p>
                    <div class="row">
                        <span class="icon">üìÖ</span>
                        <strong>Duration:</strong> ${visa.visa_length_months || 'N/A'} months
                    </div>
                    <div class="row">
                        <span class="icon">üí∞</span>
                        <strong>Min Income:</strong> $${visa.income_requirement_usd_month ? `${visa.income_requirement_usd_month.toLocaleString()}/month` : 'N/A'}
                    </div>
                    <div class="row">
                        <span class="icon">üí≥</span>
                        <strong>Visa Cost:</strong> $${visa.visa_cost_usd ? `${visa.visa_cost_usd.toLocaleString()}` : 'N/A'}
                    </div>
                    <div class="row" style="border: 2px solid ${eligibilityColor}; border-radius: 8px;">
                        <span class="icon">üõÇ</span>
                        <strong>For ${currentNationality}:</strong> <span style="color: ${eligibilityColor};">${eligibilityText}</span>
                    </div>
                    ${visa.remarks ? `<p style="font-size: 0.9rem; color: #94a3b8; margin-top: 1.5rem; padding: 1rem; background: rgba(56, 189, 248, 0.05); border-radius: 6px; border-left: 3px solid #38bdf8;"><strong>Notes:</strong> ${visa.remarks}</p>` : ''}
                    ${qualitativeRatingHtml}
                `);
                overlay.on('click', function() { d3.select(this).remove(); });
                popup.on('click', (e) => e.stopPropagation());
                updateUrlParams(g.attr('transform'));
            }
            function updateLegend(scale, filterDef) {
                const legendContainer = d3.select("#legendContainer");
                legendContainer.html('');
                legendContainer.append('div').attr('class', 'legend-title').text(filterDef.text);
                
                const legendItems = [];
                const colors = scale.range();
                if (filterDef.legendType === 'adjective') {
                    const adjectives = ADJECTIVES;
                    colors.forEach((color, i) => {
                        legendItems.push({ color: color, text: filterDef.type === 'inverted' ? adjectives[4-i] : adjectives[i]});
                    });
                } else { 
                    const labels = [];
                    if (filterDef.path === 'visas[0].visa_length_months') { 
                        labels.push('3 - 11 months', '12 - 23 months', '24 - 35 months', '36 - 47 months', '48+ months'); 
                    } 
                    else if (filterDef.path === 'visas[0].income_requirement_usd_month') { 
                        labels.push('$0 - $445', '$446 - $2,022', '$2,023 - $3,600', '$3,601 - $5,177', '$5,178+'); 
                    } 
                    else if (filterDef.path === 'visas[0].visa_cost_usd') { 
                        labels.push('$0 - $99', '$100 - $330', '$331 - $659', '$660 - $989', '$990+'); 
                    }
                    
                    colors.forEach((color, i) => {
                        legendItems.push({ color: color, text: labels[i] });
                    });
                }
                
                if (filterDef.type === 'normal' && filterDef.legendType === 'adjective') {
                    // Already handled by inverting adjectives index
                } else if (filterDef.type === 'normal') {
                    legendItems.reverse();
                }
                legendItems.forEach(item => {
                    const legendItem = d3.create('div').attr('class', 'legend-item');
                    legendItem.append('div').attr('class', 'legend-color').style('background-color', item.color);
                    legendItem.append('div').attr('class', 'legend-text').text(item.text);
                    legendContainer.node().appendChild(legendItem.node());
                });
            }
            
            d3.select('#filterSelect').on('change', function() { 
                currentFilter = this.value; 
                updateStyles(); 
                updateFilterHeadline();
                updateUrlParams(g.attr('transform')); 
            });
            d3.select('#nationalitySelect').on('change', function() { 
                currentNationality = this.value; 
                updateUrlParams(g.attr('transform')); 
            });
            // Apply URL parameters and initialize
            applyUrlParams();
            currentFilter = document.getElementById('filterSelect').value;
            currentNationality = document.getElementById('nationalitySelect').value;
            updateStyles();
        }).catch(error => {
            hideLoading();
            console.error('Error loading data:', error);
            showError(`Could not load map data. ${error.message || 'Please check your internet connection and try again.'}`);
        });
    </script>
</body>
</html>
