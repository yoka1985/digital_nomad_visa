<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Nomad Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* Darker background */
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #0f172a;
        }
        .blur-overlay {
            backdrop-filter: blur(8px);
        }
        .persona-card, .option-card {
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
            background-color: #2d3748; /* Darker card background */
            color: #cbd5e0;
        }
        .persona-card:hover, .option-card:hover {
            transform: scale(1.05);
            border-color: #6366f1;
        }
        .persona-card.selected, .option-card.selected {
            border-color: #6366f1;
            background-color: #3b4252;
            color: #ffffff;
        }
        .chart-plot-container {
            position: relative;
            height: 50px;
            width: 100%;
        }
        .chart-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        .chart-line {
            position: absolute;
            height: 2px;
            background-color: #6366f1;
            transition: all 0.3s ease;
        }
        .formkit-form, .formkit-input, .formkit-submit {
            color: #1e293b !important;
        }
        #newsletter-modal .formkit-form .formkit-input {
            border-color: #e2e8f0 !important;
        }
        #newsletter-modal .formkit-form .formkit-submit {
            background-color: #6366f1 !important;
            color: #ffffff !important;
        }
        #newsletter-modal .formkit-form .formkit-header h2,
        #newsletter-modal .formkit-form .formkit-subheader p,
        #newsletter-modal .formkit-form a {
            color: #e2e8f0 !important;
        }
        .rank-badge {
            background-color: #6366f1;
            color: #e2e8f0;
            padding: 4px 10px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem; /* text-sm */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .highlighted-cta {
            background-color: #6366f1;
            color: #ffffff;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .highlighted-cta:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }
        .map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .map-title {
            position: absolute;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem 2rem;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 2px solid #6366f1;
            text-align: center;
        }
        .city-marker {
            cursor: pointer;
            fill: #facc15;
            stroke: #0f172a;
            stroke-width: 1;
            transition: all 0.2s ease-in-out;
            transform-origin: center;
        }
        .city-marker:hover {
            transform: scale(1.5);
            fill: #6366f1;
            stroke: #e2e8f0;
        }
        .city-text {
            fill: #e2e8f0;
            font-size: 14px;
            font-weight: 600;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            pointer-events: none;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(6px);
            padding: 1rem;
        }
        
        .popup {
            position: relative;
            background: #1e293b;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(56, 189, 248, 0.4);
            max-width: 90vw;
            width: 500px;
            font-size: 1rem;
            color: #e2e8f0;
            border: 2px solid #facc15;
            max-height: 85vh;
            overflow-y: auto;
        }

        .popup-content-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding-top: 1rem;
        }
        .popup-section {
            background-color: #2d3748;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #475569;
        }
        .popup-section h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }
        .popup-section p {
            font-size: 0.9rem;
            color: #cbd5e0;
        }
        .popup-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .popup-section ul li {
            font-size: 0.85rem;
            color: #94a3b8;
        }
        .popup-section .cta-button {
            margin-top: 0.75rem;
            display: inline-block;
            background-color: #6366f1;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="bg-slate-800 text-slate-100 w-full min-h-screen p-4 sm:p-8 flex flex-col items-center text-center transition-all duration-500 ease-in-out">
        <div class="max-w-4xl w-full">

            <div id="persona-screen" class="space-y-6">
                <h1 class="text-4xl font-bold">The Nomad Compass</h1>
                <p class="text-slate-400 text-lg">Your journey, curated by **recent discussions** from thousands of digital nomads.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-8">
                    <div data-persona="newbie" class="persona-card rounded-2xl flex flex-col items-center p-6 text-center">
                        <span class="text-4xl">üéí</span>
                        <span class="mt-2 text-lg font-semibold">The Newbie Nomad</span>
                        <span class="text-sm text-slate-400 font-normal">Aspiring or new</span>
                    </div>
                    <div data-persona="experienced" class="persona-card rounded-2xl flex flex-col items-center p-6 text-center">
                        <span class="text-4xl">‚úàÔ∏è</span>
                        <span class="mt-2 text-lg font-semibold">The Experienced Nomad</span>
                        <span class="text-sm text-slate-400 font-normal">A veteran looking to optimize</span>
                    </div>
                    <div data-persona="slowmad" class="persona-card rounded-2xl flex flex-col items-center p-6 text-center">
                        <span class="text-4xl">üè°</span>
                        <span class="mt-2 text-lg font-semibold">The "Slowmad" Settler</span>
                        <span class="text-sm text-slate-400 font-normal">Seeking a long-term base</span>
                    </div>
                    <div data-persona="entrepreneur" class="persona-card rounded-2xl flex flex-col items-center p-6 text-center">
                        <span class="text-4xl">üíº</span>
                        <span class="mt-2 text-lg font-semibold">The Digital Entrepreneur</span>
                        <span class="text-sm text-slate-400 font-normal">Focused on business logistics</span>
                    </div>
                </div>
            </div>

            <div id="customization-screen" class="hidden space-y-6">
                <h2 id="customization-title" class="text-3xl font-bold"></h2>
                <p id="customization-description" class="text-slate-400 text-lg"></p>
                <div id="customization-questions" class="space-y-6 mt-8">
                    </div>
            </div>

            <div id="loading-screen" class="hidden flex flex-col items-center justify-center space-y-4">
                <div class="spinner"></div>
                <p class="text-xl font-semibold text-indigo-400">Calculating your perfect destinations...</p>
            </div>

            <div id="map-results-screen" class="hidden map-container">
                <div class="map-title">
                    <h2 class="text-3xl font-bold text-center">Top 3 Cities Based on Recent Nomads Talks</h2>
                    <p class="text-slate-400 text-center mt-2">Based on **40 Places.** <span class="font-semibold text-indigo-400 cursor-pointer" onclick="showNewsletterForm()">For more cities & filters.</span></p>
                </div>
                <div id="map-svg-container" class="w-full h-full"></div>
            </div>
        </div>
    </div>
    
    <div id="newsletter-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 text-slate-100 rounded-3xl shadow-2xl p-4 max-w-lg w-full relative">
            <button onclick="hideNewsletterForm()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
            <div class="w-full h-full overflow-y-auto">
                <script src="https://f.convertkit.com/ckjs/ck.5.js"></script>
                <form action="https://app.kit.com/forms/8378924/subscriptions" class="seva-form formkit-form" method="post" data-sv-form="8378924" data-uid="66362223a4" data-format="inline" data-version="5" data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;You‚Äôre on the list! I‚Äôll reach out when I‚Äôve got something worth sharing.&quot;,&quot;redirect_url&quot;:&quot;&quot;},&quot;analytics&quot;:{&quot;google&quot;:null,&quot;fathom&quot;:null,&quot;facebook&quot;:null,&quot;segment&quot;:null,&quot;pinterest&quot;:null,&quot;sparkloop&quot;:null,&quot;googletagmanager&quot;:null},&quot;modal&quot;:{&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15},&quot;powered_by&quot;:{&quot;show&quot;:true,&quot;url&quot;:&quot;https://kit.com/features/forms?utm_campaign=poweredby&amp;utm_content=form&amp;utm_medium=referral&amp;utm_source=dynamic&quot;},&quot;recaptcha&quot;:{&quot;enabled&quot;:false},&quot;return_visitor&quot;:{&quot;action&quot;:&quot;show&quot;,&quot;custom_content&quot;:&quot;&quot;},&quot;slide_in&quot;:{&quot;display_in&quot;:&quot;bottom_right&quot;,&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15},&quot;sticky_bar&quot;:{&quot;display_in&quot;:&quot;top&quot;,&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:5,&quot;devices&quot;:&quot;all&quot;,&quot;show_once_every&quot;:15}},&quot;version&quot;:&quot;5&quot;}" min-width="400 500 600 700 800" style="background-color: rgb(45, 55, 72); border-radius: 0px;"><div data-style="image"><div data-element="column" class="formkit-column" style="background-color: rgb(31, 41, 55); height: 480px;"><div class="formkit-background" style="background-image: url(&quot;https://embed.filekitcdn.com/e/ft8DkvccuKYS4LoHkedJCS/d1H8NRRJc6hVwY5pYWFCgx&quot;); opacity: 0.15;"></div><div class="formkit-header" data-element="header" style="color: rgb(255, 255, 255); font-size: 18px; font-weight: 700;"><h2><strong>Stay One Step Ahead, Anywhere on Earth üåç</strong></h2></div><div class="formkit-subheader" data-element="subheader" style="color: rgb(255, 255, 255); font-size: 15px;"><p>AI-curated visa updates, expat intel, and real nomad stories delivered weekly</p><p>‚Äã</p></div></div><div data-element="column" class="formkit-column"><ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul><div data-element="fields" class="seva-fields formkit-fields"><div class="formkit-field"><input class="formkit-input" name="email_address" aria-label="Email Address" placeholder="Email Address" required="" type="email" style="color: rgb(77, 77, 77); border-color: rgb(227, 227, 227); border-radius: 0px; font-weight: 400;"></div><div class="formkit-field"><input class="formkit-input" aria-label="Any feedback on the site? (optional)" name="fields[feedback]" placeholder="Any feedback on the site? (optional)" type="text" style="color: rgb(77, 77, 77); border-color: rgb(227, 227, 227); border-radius: 0px; font-weight: 400;"></div><button data-element="submit" class="formkit-submit formkit-submit" style="color: rgb(255, 255, 255); background-color: rgb(51, 51, 51); border-radius: 0px; font-weight: 400;"><div class="formkit-spinner"><div></div><div></div><div></div></div><span class="">Keep Me in the Loop</span></button></div><div class="formkit-powered-by-convertkit-container"><a href="https://kit.com/features/forms?utm_campaign=poweredby&amp;utm_content=form&amp;utm_medium=referral&amp;utm_source=dynamic" data-element="powered-by" class="formkit-powered-by-convertkit" data-variant="dark" target="_blank" rel="nofollow">Built with Kit</a></div></div></div></form>
            </div>
        </div>
    </div>


    <script>
        // Data source to be used for the map. Adding coordinates for markers.
        const destinationData = [
            {
                name: "Paris",
                country: "France",
                continent: "Europe",
                costMonthly: "‚Ç¨2,500",
                weather: {
                    "max 1 month": "Pleasant üå§Ô∏è",
                    "1-3 months": "Warm and breezy üå¨Ô∏è",
                    "3+ months": "Pleasant, with rainy days üå¶Ô∏è"
                },
                internetSpeed: "200 Mbps",
                image_url: "https://placehold.co/600x400/3b4252/e2e8f0?text=Paris,+France",
                coords: [2.3522, 48.8566], // [lon, lat]
                factors: [
                    { name: "Wifi Connectivity", score: 4.0, summary: "Fast internet is widely available, with fiber optic connections common. While caf√© Wi-Fi can be inconsistent, public libraries offer reliable, free, high-speed access.", hiddenGems: [{ tip: "Public libraries are great unadvertised spots for quiet, free, and reliable Wi-Fi, often overlooked by tourists.", confidence: 4.5, period: "last6mo" }] },
                    { name: "Cost of Living", score: 2.0, summary: "Very high cost of living, especially for housing in central areas. The high expense makes Paris a poor value destination for many nomads, but careful budgeting, cooking, and using free attractions can make it manageable.", hiddenGems: [{ tip: "Discovering local food markets and cooking can dramatically cut costs.", confidence: 4.0, period: "last3mo" }] },
                    { name: "Community", score: 3.0, summary: "A small, but growing, digital nomad community exists. It is difficult to integrate into the local culture without speaking French, but there are active expat and language exchange groups.", hiddenGems: [{ tip: "The 'Social Bar Paris' is a popular spot for meeting new people, recommended in online discussions.", confidence: 3.8, period: "last6mo" }] },
                    { name: "Lifestyle Activities", score: 5.0, summary: "A cultural haven with world-class museums, art, food, and music. The city is highly walkable and bike-friendly, with many free or low-cost activities available.", hiddenGems: [{ tip: "The city is home to many small, unadvertised art galleries and charming hidden passages.", confidence: 4.2, period: "last3mo" }] },
                    { name: "Safety", score: 4.0, summary: "Generally safe, but requires street smarts, especially at night and in tourist-heavy areas. Pickpocketing and petty theft are common concerns.", hiddenGems: [{ tip: "Some locals recommend keeping valuables in a front pocket and being wary in crowded metro stations.", confidence: 4.0, period: "last6mo" }] },
                    { name: "Healthcare", score: 5.0, summary: "Exceptional healthcare system with high-quality public and private options. As part of the EU, many nomads with travel insurance can access services easily.", hiddenGems: [{ tip: "Many pharmacies have on-site pharmacists who can offer basic advice for minor ailments without a doctor's visit.", confidence: 4.0, period: "last1yr" }] },
                    { name: "Accommodation Availability", score: 3.0, summary: "A wide variety of options from hostels to high-end apartments exist, but rentals, especially short-term ones, are often very small for the price. Co-living spaces are limited but growing.", hiddenGems: [{ tip: "Finding an unlisted sublet or a rental in the suburbs can be a great way to find a better deal on a larger space.", confidence: 4.2, period: "last6mo" }] },
                    { name: "Work Environment", score: 4.0, summary: "The city is dense with co-working spaces. Caf√©s are generally not laptop-friendly, as they are for socializing, but free Wi-Fi is available in many public libraries.", hiddenGems: [{ tip: "Some smaller, lesser-known cafes in less touristy areas are more lenient with laptop use during off-peak hours.", confidence: 3.5, period: "last6mo" }] },
                    { name: "Family & Pet Friendliness", score: 3.0, summary: "While Paris has family-friendly parks and good schools, finding pet-friendly apartments can be difficult and expensive.", hiddenGems: [{ tip: "Some neighborhoods have small, local pet parks not listed on tourist maps.", confidence: 3.0, period: "last3mo" }] },
                    { name: "Food & Cuisine", score: 5.0, summary: "A culinary paradise offering everything from Michelin-starred restaurants to affordable, high-quality street food. The city is also known for its fresh local markets.", hiddenGems: [{ tip: "There are many 'secret' bakeries with superior croissants and pastries that locals frequent.", confidence: 4.8, period: "last3mo" }] }
                ],
                communityPulse: { currentSentiment: 3.2, sentimentExplainer: "Mixed feelings‚Äîlove culture but frustrated with costs.", trendDirection: -0.4, trendExplainer: "Declining due to post-pandemic rent increases." },
                hotSecrets: "Online discussions confirm fast home internet but note cafe instability, and praise public libraries as great unadvertised spots for quiet, free, and reliable Wi-Fi, often overlooked by tourists.",
                popularity: [4, 5, 5], // Scores for last 3 years
            },
            {
                name: "Lisbon",
                country: "Portugal",
                continent: "Europe",
                costMonthly: "‚Ç¨1,200",
                weather: {
                    "max 1 month": "Sunny and mild ‚òÄÔ∏è",
                    "1-3 months": "Warm and breezy üå¨Ô∏è",
                    "3+ months": "Pleasant, with a few rainy days üå¶Ô∏è"
                },
                internetSpeed: "200 Mbps",
                image_url: "https://placehold.co/600x400/3b4252/e2e8f0?text=Lisbon,+Portugal",
                coords: [-9.1393, 38.7223],
                factors: [
                    { name: "Wifi Connectivity", score: 5.0, summary: "Fiber internet is widely available and highly reliable. Co-working spaces are plentiful and offer top-tier speeds.", hiddenGems: [{ tip: "Public libraries and certain city parks offer surprisingly good free Wi-Fi.", confidence: 4.0, period: "last6mo" }] },
                    { name: "Cost of Living", score: 3.0, summary: "Rent prices have been increasing, but day-to-day costs for food and transport are still manageable. It's a moderate budget destination for most nomads.", hiddenGems: [{ tip: "Explore the suburbs for much cheaper rent and a more local vibe.", confidence: 4.5, period: "last3mo" }] },
                    { name: "Community", score: 5.0, summary: "A very active and welcoming digital nomad community with numerous meetups and social groups reported weekly. It's easy to connect and find support.", hiddenGems: [{ tip: "Join local language exchange groups to meet locals and other expats.", confidence: 4.8, period: "last6mo" }] },
                    { name: "Visa Process", score: 5.0, summary: "The new Digital Nomad Visa application process is frequently discussed and praised for being straightforward and a viable long-term option.", hiddenGems: [{ tip: "Consult local nomad-friendly law firms for a smooth application process.", confidence: 5.0, period: "last3mo" }] },
                    { name: "Safety", score: 4.0, summary: "General safety is high, but common-sense precautions against pickpocketing, especially in tourist-heavy areas, are a must.", hiddenGems: [{ tip: "Be aware of your surroundings in crowded trams and metro stations.", confidence: 4.0, period: "last6mo" }] },
                ],
                communityPulse: { currentSentiment: 4.5, sentimentExplainer: "Generally positive, high satisfaction with the visa and community.", trendDirection: 0.2, trendExplainer: "Slightly improving as visa processes become more clear." },
                hotSecrets: "This month's hottest topic is a new freelance visa program. Community consensus is highly positive (4/5 stars) as it simplifies the legal process.",
                popularity: [4, 5, 5], // Scores for last 3 years
            },
            {
                name: "Chiang Mai",
                country: "Thailand",
                continent: "Asia",
                costMonthly: "‚Ç¨700",
                weather: {
                    "max 1 month": "Hot and humid ü•µ",
                    "1-3 months": "Monsoon season, with afternoon showers ‚òî",
                    "3+ months": "Pleasant, cooler weather üå¨Ô∏è"
                },
                internetSpeed: "100 Mbps",
                image_url: "https://placehold.co/600x400/3b4252/e2e8f0?text=Chiang+Mai,+Thailand",
                coords: [98.9817, 18.7061],
                factors: [
                    { name: "Wifi Connectivity", score: 4.0, summary: "Fast home internet is widely available, though caf√© Wi-Fi can be inconsistent. Remote areas might have slower speeds.", hiddenGems: [{ tip: "Check for fiber optic providers like AIS Fibre before renting an apartment.", confidence: 4.5, period: "last3mo" }] },
                    { name: "Cost of Living", score: 5.0, summary: "An extremely low cost of living, especially for housing and food. It is one of the most budget-friendly destinations for new nomads.", hiddenGems: [{ tip: "Eating at local night markets instead of tourist restaurants can save you a lot of money.", confidence: 5.0, period: "last1mo" }] },
                    { name: "Community", score: 5.0, summary: "A huge, well-established digital nomad community exists. It's a great place to meet other like-minded individuals.", hiddenGems: [{ tip: "Join the local Digital Nomad Facebook groups for real-time meet-up announcements.", confidence: 5.0, period: "last1mo" }] },
                    { name: "Visa Process", score: 4.0, summary: "The visa process can be complex with visa extensions and border runs required for longer stays. Many discussions focus on navigating this system.", hiddenGems: [{ tip: "The best border run option is a quick trip to Laos or Myanmar for a new visa stamp.", confidence: 4.0, period: "last6mo" }] },
                    { name: "Safety", score: 4.0, summary: "Generally very safe, with low crime rates. The main concern is road safety due to the large number of scooters.", hiddenGems: [{ tip: "Always wear a helmet and drive cautiously, especially during the night.", confidence: 4.5, period: "last3mo" }] },
                ],
                communityPulse: { currentSentiment: 4.0, sentimentExplainer: "High satisfaction with low cost of living and strong community.", trendDirection: 0.1, trendExplainer: "Slowly improving as visa rules become clearer." },
                hotSecrets: "This month's community consensus is exploring hidden food spots outside the main tourist areas. The sentiment is very positive (5/5 stars).",
                popularity: [3, 4, 4],
            },
            {
                name: "Medell√≠n",
                country: "Colombia",
                continent: "South America",
                costMonthly: "‚Ç¨850",
                weather: {
                    "max 1 month": "Perfectly spring-like üå∏",
                    "1-3 months": "Cloudy with sunny intervals üå§Ô∏è",
                    "3+ months": "Pleasant year-round ‚òÄÔ∏è"
                },
                internetSpeed: "300 Mbps",
                image_url: "https://placehold.co/600x400/3b4252/e2e8f0?text=Medellin,+Colombia",
                coords: [-75.5670, 6.2442],
                factors: [
                    { name: "Wifi Connectivity", score: 5.0, summary: "Widespread fiber optic internet makes Medell√≠n one of the most connected cities for nomads. Speeds are fast and reliable.", hiddenGems: [{ tip: "Specific co-working spaces offer speeds of up to 1GB for a slightly higher fee.", confidence: 4.8, period: "last3mo" }] },
                    { name: "Cost of Living", score: 4.0, summary: "A moderate cost of living that offers great value for money. Most nomads can afford a comfortable lifestyle on a reasonable budget.", hiddenGems: [{ tip: "To save on rent, consider living in a co-living space for the first few months.", confidence: 4.0, period: "last6mo" }] },
                    { name: "Community", score: 4.0, summary: "A friendly and growing community with regular meetups and social events. Integration with the local culture is also highly praised.", hiddenGems: [{ tip: "Join a local sports club or language class to meet people outside of the nomad scene.", confidence: 4.2, period: "last3mo" }] },
                    { name: "Safety", score: 3.0, summary: "Safety is a frequent topic of discussion. While generally safe in tourist areas, street smarts and situational awareness are a must.", hiddenGems: [{ tip: "Avoid displaying expensive electronics or jewelry in public spaces.", confidence: 4.5, period: "last1mo" }] },
                    { name: "Visa Process", score: 4.0, summary: "The process for long-term stay is well-documented and manageable. Many discussions focus on the Temporary Resident Visa and its requirements.", hiddenGems: [{ tip: "Hiring a local immigration lawyer is a common tip for a smoother visa process.", confidence: 4.0, period: "last6mo" }] },
                ],
                communityPulse: { currentSentiment: 4.2, sentimentExplainer: "Positive sentiment around infrastructure and community, but with some concerns on safety.", trendDirection: 0.3, trendExplainer: "Positive trend as the city invests in more modern infrastructure." },
                hotSecrets: "This month's community consensus is on safety tips and best practices for new arrivals. The sentiment is positive (4/5 stars), with a focus on caution.",
                popularity: [2, 3, 4],
            },
            {
                name: "Budapest",
                country: "Hungary",
                continent: "Europe",
                costMonthly: "‚Ç¨950",
                weather: {
                    "max 1 month": "Pleasant and warm ‚òÄÔ∏è",
                    "1-3 months": "Cooling down with a crisp breeze üçÇ",
                    "3+ months": "Cold, snowy winters ‚ùÑÔ∏è"
                },
                internetSpeed: "220 Mbps",
                image_url: "https://placehold.co/600x400/3b4252/e2e8f0?text=Budapest,+Hungary",
                coords: [19.0402, 47.4979],
                factors: [
                    { name: "Wifi Connectivity", score: 5.0, summary: "The community consistently rates the internet as excellent, with fast and reliable connections.", hiddenGems: [{ tip: "Look for apartments with Vodafone or Digi for the fastest speeds.", confidence: 4.8, period: "last3mo" }] },
                    { name: "Cost of Living", score: 4.0, summary: "A very affordable cost of living for a European capital. Rent is reasonable, and food and public transport are cheap.", hiddenGems: [{ tip: "Buying a monthly pass for public transport is a great way to save money and travel around the city.", confidence: 4.5, period: "last6mo" }] },
                    { name: "Community", score: 4.0, summary: "A welcoming, established digital nomad community with numerous meetups and social events. It's a great place for new and experienced nomads.", hiddenGems: [{ tip: "The 'Budapest Digital Nomads' Facebook group is a must-join for finding events and housing.", confidence: 5.0, period: "last1mo" }] },
                    { name: "Visa Process", score: 4.0, summary: "Feedback indicates a clear, but sometimes bureaucratic, process for the Digital Nomad Visa. Many online resources and expat groups offer great advice.", hiddenGems: [{ tip: "Hire a local accountant to assist with the visa and tax process for a smoother experience.", confidence: 4.0, period: "last6mo" }] },
                    { name: "Safety", score: 4.0, summary: "Nomads report a high sense of safety, with posts on common-sense precautions being the main concern.", hiddenGems: [{ tip: "Be wary of taxi scams and always agree on a price beforehand or use ride-hailing apps.", confidence: 4.2, period: "last3mo" }] },
                ],
                communityPulse: { currentSentiment: 4.0, sentimentExplainer: "High satisfaction with affordability and infrastructure, with some bureaucracy frustrations.", trendDirection: 0.0, trendExplainer: "Stable community sentiment with consistent feedback." },
                hotSecrets: "This month's discussions are focused on the best thermal baths to work from. Community consensus is very positive (5/5 stars) as many have found quiet spots with good WiFi.",
                popularity: [5, 4, 4],
            },
        ];

        // UI elements
        const personaScreen = document.getElementById('persona-screen');
        const customizationScreen = document.getElementById('customization-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const mapResultsScreen = document.getElementById('map-results-screen');
        const customizationQuestions = document.getElementById('customization-questions');
        const customizationTitle = document.getElementById('customization-title');
        const customizationDescription = document.getElementById('customization-description');
        const newsletterModal = document.getElementById('newsletter-modal');
        const popupContainer = document.getElementById('popup-container');
        
        let newsletterForm = null;
        let appState = {
            persona: null,
            customizations: {},
            currentQuestionIndex: 0,
            isUnlocked: false
        };

        const questions = [
            {
                label: "What's your monthly budget?",
                key: "budget",
                options: [
                    { emoji: "üí∏", text: "Under ‚Ç¨1K", value: "Under ‚Ç¨1K" },
                    { emoji: "üí∞", text: "‚Ç¨1K-‚Ç¨2.5K", value: "‚Ç¨1K-‚Ç¨2.5K" },
                    { emoji: "ü§ë", text: "Over ‚Ç¨2.5K", value: "Over ‚Ç¨2.5K" },
                    { emoji: "ü§î", text: "Not sure", value: "Not sure" }
                ]
            },
            {
                label: "Which continent?",
                key: "continent",
                options: [
                    { emoji: "üá™üá∫", text: "Europe", value: "Europe" },
                    { emoji: "üåè", text: "Asia", value: "Asia" },
                    { emoji: "üåé", text: "S. America", value: "South America" },
                    { emoji: "üó∫Ô∏è", text: "Open to all", value: "Open to all" }
                ]
            },
            {
                label: "How long will you stay?",
                key: "period",
                options: [
                    { emoji: "üèÉ", text: "Max 1 mo.", value: "max 1 month" },
                    { emoji: "üö∂‚Äç‚ôÄÔ∏è", text: "1-3 mos.", value: "1-3 months" },
                    { emoji: "üè°", text: "3+ mos.", value: "3+ months" },
                    { emoji: "ü§î", text: "Not sure", value: "not sure" }
                ]
            },
            {
                label: "What's your preferred environment?",
                key: "environment",
                options: [
                    { emoji: "üèôÔ∏è", text: "City", value: "City" },
                    { emoji: "üèñÔ∏è", text: "Beach", value: "Beach" },
                    { emoji: "üèîÔ∏è", text: "Mountains", value: "Mountains" },
                    { emoji: "üîÑ", text: "Either", value: "Either" }
                ]
            }
        ];

        const personaConfig = {
            newbie: {
                emoji: 'üéí',
                title: 'Newbie Nomad',
                description: 'Just starting your journey?',
                metrics: { costOfLiving: 'Monthly Cost', internetReliability: 'WiFi', safety: 'Safety' }
            },
            experienced: {
                emoji: '‚úàÔ∏è',
                title: 'Experienced Nomad',
                description: 'Looking for a new challenge?',
                metrics: { taxFriendliness: 'Tax Friendly', visaProcess: 'Visa Ease', infrastructure: 'Infrastructure' }
            },
            slowmad: {
                emoji: 'üè°',
                title: 'Slowmad Settler',
                description: 'Ready to settle down?',
                metrics: { communityVibe: 'Community', residencyEase: 'Residency', healthcareQuality: 'Healthcare' }
            },
            entrepreneur: {
                emoji: 'üíº',
                title: 'Digital Entrepreneur',
                description: 'Business first, travel second?',
                metrics: { businessEnvironment: 'Business Env', paymentGateways: 'Payments', startupScene: 'Startup Scene' }
            }
        };
        
        // Helper functions
        const findFactor = (destination, factorName) => destination.factors.find(f => f.name === factorName);
        
        const getEmojiFromScore = (score) => {
            if (score >= 4) return '‚ö°Ô∏è';
            if (score >= 3) return 'üö∂‚Äç‚ôÄÔ∏è';
            return '';
        };

        const getCostEmoji = (score) => {
            if (score >= 4) return 'üí∏';
            if (score >= 3) return 'üí∞';
            return 'üíµ';
        };

        const renderStars = (rating) => {
            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < rating) {
                    stars += `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
                } else {
                    stars += `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
                }
            }
            return `<div class="flex">${stars}</div>`;
        };

        const showScreen = (screenId) => {
            const screens = [personaScreen, customizationScreen, loadingScreen, mapResultsScreen];
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
        };

        document.querySelectorAll('.persona-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                const persona = card.dataset.persona;
                appState.persona = persona;
                
                setTimeout(() => {
                    appState.currentQuestionIndex = 0;
                    renderQuestionScreen();
                    showScreen('customization-screen');
                }, 300);
            });
        });

        const renderQuestionScreen = () => {
            const currentQuestion = questions[appState.currentQuestionIndex];
            const config = personaConfig[appState.persona];
            
            customizationTitle.innerHTML = `${config.emoji} ${config.title}`;
            customizationDescription.textContent = currentQuestion.label;
            
            const optionsHtml = currentQuestion.options.map(option => `
                <button data-question="${currentQuestion.key}" data-option="${option.value}" class="option-card bg-slate-700 py-2 px-4 rounded-full flex items-center justify-center space-x-2">
                    <span class="text-2xl">${option.emoji}</span>
                    <span class="text-lg font-medium">${option.text}</span>
                </button>
            `).join('');

            customizationQuestions.innerHTML = `
                <div class="space-y-4 text-left">
                    <p class="font-semibold">${currentQuestion.label}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${optionsHtml}
                    </div>
                </div>
            `;

            document.querySelectorAll('.option-card').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.option-card').forEach(btn => btn.classList.remove('selected'));
                    e.target.closest('.option-card').classList.add('selected');

                    const questionKey = currentQuestion.key;
                    const optionValue = e.target.closest('.option-card').dataset.option;
                    appState.customizations[questionKey] = optionValue;
                    
                    setTimeout(() => {
                        appState.currentQuestionIndex++;
                        if (appState.currentQuestionIndex < questions.length) {
                            renderQuestionScreen();
                        } else {
                            showScreen('loading-screen');
                            setTimeout(() => {
                                renderMapResults();
                                showScreen('map-results-screen');
                            }, 2000); // Simulate calculation time
                        }
                    }, 300);
                });
            });
        };

        const renderMapResults = () => {
            document.getElementById('map-results-screen').innerHTML = `
                <div class="map-title">
                    <h2 class="text-3xl font-bold text-center">Top 3 Cities Based on Recent Nomads Talks</h2>
                    <p class="text-slate-400 text-center mt-2">Based on **40 Places.** <span class="font-semibold text-indigo-400 cursor-pointer" onclick="showNewsletterForm()">For more cities & filters.</span></p>
                </div>
                <div id="map-svg-container" class="w-full h-full"></div>
            `;
            
            const { width, height } = { width: window.innerWidth, height: window.innerHeight };
            
            const svg = d3.select('#map-svg-container').append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');
            
            const projection = d3.geoMercator()
                .scale(width / (2 * Math.PI) * 0.85)
                .translate([width / 2, height / 1.8]);
            
            const path = d3.geoPath().projection(projection);
            const g = svg.append("g");
            
            d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').then(topoData => {
                const geoData = topojson.feature(topoData, topoData.objects.countries);
                
                g.selectAll('path')
                    .data(geoData.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('fill', '#334155')
                    .attr('stroke', '#1e293b');
                
                // Add city markers for the top 3 cities
                const top3Cities = destinationData.slice(0, 3);
                
                svg.selectAll("circle")
                    .data(top3Cities)
                    .enter()
                    .append("circle")
                    .attr("cx", d => projection(d.coords)[0])
                    .attr("cy", d => projection(d.coords)[1])
                    .attr("r", 10)
                    .attr("class", "city-marker")
                    .on("click", (event, d) => showCityPopup(event, d));
                
                // Add city labels
                svg.selectAll("text")
                    .data(top3Cities)
                    .enter()
                    .append("text")
                    .attr("x", d => projection(d.coords)[0] + 12)
                    .attr("y", d => projection(d.coords)[1] + 4)
                    .text(d => d.name)
                    .attr("class", "city-text");
            });

            // Center the map to show top cities better
            const topCitiesCentroid = d3.geoCentroid({
                type: "FeatureCollection",
                features: destinationData.slice(0, 3).map(d => ({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: d.coords
                    }
                }))
            });

            const currentMapScale = projection.scale();
            const [cx, cy] = projection(topCitiesCentroid);
            const zoomTransform = d3.zoomIdentity.translate(width / 2 - cx * currentMapScale, height / 2 - cy * currentMapScale).scale(currentMapScale);
            svg.call(d3.zoom().transform, zoomTransform);
        };
        const showCityPopup = (event, city) => {
            // Remove any existing popups
            d3.selectAll('.popup-overlay').remove();
            
            const persona = appState.persona;
            const internetFactor = findFactor(city, "Wifi Connectivity");
            const costFactor = findFactor(city, "Cost of Living");
            const periodWeather = city.weather[appState.customizations.period] || city.weather["max 1 month"];
            
            const internetScore = internetFactor?.score || 0;
            const costScore = costFactor?.score || 0;
            
            const getInternetEmoji = (score) => {
                if (score >= 4) return '‚ö°Ô∏è';
                if (score >= 3) return 'üö∂‚Äç‚ôÄÔ∏è';
                return 'üê¢';
            };

            const getCostEmoji = (score) => {
                if (score >= 4) return 'üí∏';
                if (score >= 3) return 'üí∞';
                return 'üíµ';
            };
            
            const renderPopularityPlot = (scores) => {
                const maxScore = 5;
                const years = ["'22", "'23", "'24"];
                const svgWidth = 100;
                const svgHeight = 50;
                const margin = { top: 5, right: 5, bottom: 5, left: 5 };
                const plotWidth = svgWidth - margin.left - margin.right;
                const plotHeight = svgHeight - margin.top - margin.bottom;

                const xScale = d3.scaleLinear().domain([0, scores.length - 1]).range([0, plotWidth]);
                const yScale = d3.scaleLinear().domain([0, maxScore]).range([plotHeight, 0]);

                const line = d3.line()
                    .x((d, i) => xScale(i))
                    .y(d => yScale(d))
                    .curve(d3.curveMonotoneX); // Make the line smoother

                let svg = `<svg class="w-full h-16" viewBox="0 0 ${svgWidth + margin.left + margin.right} ${svgHeight + margin.top + margin.bottom}" preserveAspectRatio="none">
                    <g transform="translate(${margin.left}, ${margin.top})">
                        <path d="${line(scores)}" fill="none" stroke="#6366f1" stroke-width="2" />
                        ${scores.map((score, index) => `<circle cx="${xScale(index)}" cy="${yScale(score)}" r="3" fill="#facc15" stroke="#1e293b" stroke-width="1" />`).join('')}
                        ${years.map((year, index) => `<text x="${xScale(index)}" y="${plotHeight + 10}" text-anchor="middle" font-family="Inter, sans-serif" font-size="8" fill="#94a3b8">${year}</text>`).join('')}
                    </g>
                </svg>`;
                return svg;
            };

            const popupHtml = `
                <div class="header">${city.name}, ${city.country}</div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="flex flex-col items-start space-x-2">
                        <span class="text-2xl">${getCostEmoji(costScore)}</span>
                        <div>
                            <p class="text-sm font-medium">Monthly Cost</p>
                            <p class="text-lg font-bold">${city.costMonthly}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-start space-x-2">
                        <span class="text-2xl">${getInternetEmoji(internetScore)}</span>
                        <div>
                            <p class="text-sm font-medium">Internet Speed</p>
                            <p class="text-lg font-bold">${city.internetSpeed}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-start space-x-2">
                        <span class="text-2xl">‚òÄÔ∏è</span>
                        <div>
                            <p class="text-sm font-medium">Weather</p>
                            <p class="text-lg font-bold">${periodWeather}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-start space-x-2">
                        <span class="text-2xl">üìà</span>
                        <div>
                            <p class="text-sm font-medium">Nomads Liking</p>
                            ${renderPopularityPlot(city.popularity)}
                        </div>
                    </div>
                </div>

                <div class="mt-6 border-t border-slate-600 pt-4 text-left">
                    <h4 class="text-base font-bold">Community Consensus</h4>
                    <p class="text-sm text-slate-400 mt-2">${city.hotSecrets}</p>
                    <button onclick="showSecretsPopup('${city.name}')" class="text-indigo-400 hover:text-indigo-200 text-sm mt-2">More secrets & tips...</button>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="showMoreDataPopup('${city.name}')" class="highlighted-cta">More scores/data</button>
                </div>
            `;
            
            const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
            const popup = overlay.append('div').attr('class', 'popup');
            popup.html(popupHtml);
            
            overlay.on('click', function() { d3.select(this).remove(); });
            popup.on('click', (e) => e.stopPropagation());
        };

        const showSecretsPopup = (cityName) => {
            const city = destinationData.find(d => d.name === cityName);
            const secretsHtml = (city?.factors || []).map(factor => `
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">${factor.name}</h5>
                    <p class="text-sm text-slate-400 italic">${factor.summary}</p>
                    <ul>
                        ${(factor.hiddenGems || []).map(gem => `
                            <li class="mt-1 pl-4 border-l border-indigo-400 italic text-xs">
                                "${gem.tip}"
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');

            const popupHtml = `
                <div class="header">${cityName} - Community Secrets</div>
                <div class="popup-content-container">
                    ${secretsHtml}
                </div>
                <div class="mt-6 text-center">
                    <button onclick="hideDetailsPopup()" class="highlighted-cta">Close</button>
                </div>
            `;

            d3.selectAll('.popup-overlay').remove();
            const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
            const popup = overlay.append('div').attr('class', 'popup');
            popup.html(popupHtml);
            
            overlay.on('click', function() { d3.select(this).remove(); });
            popup.on('click', (e) => e.stopPropagation());
        };
        
        const showMoreDataPopup = (cityName) => {
            const city = destinationData.find(d => d.name === cityName);

            const metricsHtml = city.factors.map(metric => `
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">${metric.name}</h5>
                    <div class="flex items-center mt-1">
                        ${renderStars(metric.score)}
                    </div>
                    <p class="text-xs text-slate-400 italic mt-1">${metric.summary}</p>
                </div>
            `).join('');

            const popupHtml = `
                <div class="header">${cityName} - More Scores/Data</div>
                <div class="popup-content-container">
                    ${metricsHtml}
                </div>
                <div class="mt-6 text-center">
                    <button onclick="hideDetailsPopup()" class="highlighted-cta">Close</button>
                </div>
            `;

            d3.selectAll('.popup-overlay').remove();
            const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
            const popup = overlay.append('div').attr('class', 'popup');
            popup.html(popupHtml);

            overlay.on('click', function() { d3.select(this).remove(); });
            popup.on('click', (e) => e.stopPropagation());
        };

        const showWeatherPopup = (cityName) => {
            const city = destinationData.find(d => d.name === cityName);
            const weather = city.climate;

            const weatherHtml = `
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">Average Temperature Range</h5>
                    <p class="text-sm text-slate-400 italic mt-1">
                        ${weather.avgTempRange.min}¬∞C to ${weather.avgTempRange.max}¬∞C
                    </p>
                </div>
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">Rainy Months</h5>
                    <p class="text-sm text-slate-400 italic mt-1">
                        ${weather.rainyMonths.join(', ')}
                    </p>
                </div>
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">Best Months for Visit</h5>
                    <p class="text-sm text-slate-400 italic mt-1">
                        ${weather.bestMonths.join(', ')}
                    </p>
                </div>
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">Air Quality Score</h5>
                    <div class="flex items-center mt-1">
                        ${renderStars(weather.airQuality)}
                    </div>
                </div>
                <div class="mb-4">
                    <h5 class="font-semibold text-indigo-400">Recent Community Sentiment</h5>
                    <div class="flex items-center mt-1">
                        ${renderStars(weather.recentSentiment)}
                    </div>
                    <p class="text-xs text-slate-400 italic mt-1">
                        ${weather.communityNote}
                    </p>
                </div>
            `;
            
            const popupHtml = `
                <div class="header">${cityName} - Weather Details</div>
                <div class="popup-content-container">
                    ${weatherHtml}
                </div>
                <div class="mt-6 text-center">
                    <button onclick="hideDetailsPopup()" class="highlighted-cta">Close</button>
                </div>
            `;

            d3.selectAll('.popup-overlay').remove();
            const overlay = d3.select('body').append('div').attr('class', 'popup-overlay');
            const popup = overlay.append('div').attr('class', 'popup');
            popup.html(popupHtml);

            overlay.on('click', function() { d3.select(this).remove(); });
            popup.on('click', (e) => e.stopPropagation());
        }

        const hideDetailsPopup = () => {
            d3.selectAll('.popup-overlay').remove();
        };

        const showNewsletterForm = () => {
            newsletterModal.classList.remove('hidden');
            if (newsletterForm) {
                newsletterForm.addEventListener('submit', handleFormSubmit, { once: true });
            }
        };

        const hideNewsletterForm = () => {
            newsletterModal.classList.add('hidden');
        };

        const handleFormSubmit = (e) => {
            e.preventDefault();
            setTimeout(() => {
                hideNewsletterForm();
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50';
                messageBox.innerHTML = `
                    <div class="bg-white text-slate-800 rounded-3xl shadow-2xl p-6 max-w-sm w-full text-center">
                        <h3 class="text-2xl font-bold">Success!</h3>
                        <p class="text-gray-600 mt-2">Thank you for subscribing! Your full list is on the way.</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full mt-4 shadow-lg hover:bg-indigo-700 transition-colors duration-300">Close</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }, 1000);
        }

        window.onload = () => {
            showScreen('persona-screen');
            newsletterForm = document.querySelector('.formkit-form');
        }
    </script>
</body>
</html>
