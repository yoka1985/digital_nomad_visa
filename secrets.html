<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Your Next Bali</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6N573S8D8S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', { 'analytics_storage': 'denied' });
        function initGoogleAnalytics() {
            gtag('consent', 'update', { 'analytics_storage': 'granted' });
            gtag('js', new Date());
            gtag('config', 'G-6N573S8D8S');
        }
        initGoogleAnalytics();
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        
        .persona-card, .option-card {
            transition: all 0.2s ease-in-out;
            transform-origin: center;
        }
        
        .persona-card:hover, .option-card:hover {
            transform: scale(1.05);
        }
        
        .persona-card.selected, .option-card.selected {
            border: 2px solid #6366f1;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .spinner {
            border: 4px solid #334155;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .map-marker {
            fill: #facc15;
            stroke: #1e293b;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            transform-origin: center;
        }
        
        .map-marker:hover {
            transform: scale(1.5);
        }
        
        .popup-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.7);
        }
        
        .popup-content {
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        .cta-button {
            background: #6366f1;
            transition: all 0.2s ease-in-out;
        }
        
        .cta-button:hover {
            background: #5855eb;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-800 text-slate-200">
    
    <div id="welcomeScreen" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-bold mb-4">
                Find Your Next Bali <br>
                <span class="text-2xl md:text-3xl text-slate-400">(Before Everyone Else Does...)</span>
            </h1>
            <p class="text-lg md:text-xl text-slate-300 max-w-2xl mx-auto">
                Your next chapter, decoded from nomads sharing what's real right now.
            </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl w-full">
            <div class="persona-card bg-slate-700 rounded-lg p-6 cursor-pointer" data-persona="explorer">
                <div class="text-4xl mb-4">üéí</div>
                <h3 class="text-xl font-semibold mb-2">The Explorer</h3>
                <p class="text-slate-300">Short-term travel & cultural immersion.</p>
            </div>
            
            <div class="persona-card bg-slate-700 rounded-lg p-6 cursor-pointer" data-persona="workationer">
                <div class="text-4xl mb-4">‚úàÔ∏è</div>
                <h3 class="text-xl font-semibold mb-2">The Workationer</h3>
                <p class="text-slate-300">Mixing work with travel (weeks to months).</p>
            </div>
            
            <div class="persona-card bg-slate-700 rounded-lg p-6 cursor-pointer" data-persona="relocator">
                <div class="text-4xl mb-4">üè°</div>
                <h3 class="text-xl font-semibold mb-2">The Relocator</h3>
                <p class="text-slate-300">Seeking a new permanent/semi-permanent base.</p>
            </div>
            
            <div class="persona-card bg-slate-700 rounded-lg p-6 cursor-pointer" data-persona="remote-professional">
                <div class="text-4xl mb-4">üíº</div>
                <h3 class="text-xl font-semibold mb-2">The Remote Professional</h3>
                <p class="text-slate-300">Primarily working, location flexibility.</p>
            </div>
        </div>
    </div>
    
    <div id="customizationScreen" class="hidden min-h-screen flex flex-col items-center justify-center p-6">
        <div class="text-center mb-12">
            <h2 id="personaTitle" class="text-3xl md:text-5xl font-bold mb-8"></h2>
        </div>
        
        <div id="questionContainer" class="max-w-2xl w-full">
        </div>
    </div>
    
    <div id="loadingScreen" class="hidden min-h-screen flex flex-col items-center justify-center">
        <div class="spinner mb-6"></div>
        <p class="text-xl">Calculating your perfect destinations...</p>
    </div>
    
    <div id="mapScreen" class="hidden">
        <div class="absolute top-6 left-6 z-10 bg-slate-800 bg-opacity-90 p-4 rounded-lg">
            <h3 class="text-2xl font-bold mb-2">Top 3 Cities</h3>
            <p class="text-slate-300">
                Based on 54 Places. For more cities & filters 
                <button id="signupCTA" class="text-indigo-400 hover:text-indigo-300 underline cursor-pointer">join here</button>.
            </p>
        </div>
        
        <div id="mapContainer" class="map-container">
            <svg id="worldMap" width="100%" height="100%"></svg>
        </div>
    </div>
    
    <div id="cityPopup" class="hidden fixed inset-0 popup-overlay z-50 flex items-center justify-center p-4">
        <div class="popup-content rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="cityTitle" class="text-2xl font-bold"></h3>
                <button id="closeCityPopup" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h4 class="font-semibold mb-2">Monthly Cost</h4>
                    <p id="monthlyCost" class="text-lg"></p>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">Internet Speed/Stability</h4>
                    <p id="internetInfo" class="text-lg"></p>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">Climate</h4>
                    <p id="climateInfo" class="text-lg"></p>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">Nomads Liking</h4>
                    <div id="nomadsChart" class="h-32"></div>
                </div>
            </div>
            
            <div class="mb-6">
                <button id="moreScoresBtn" class="cta-button text-white px-4 py-2 rounded-lg mr-4">More Scores/Data</button>
                <button id="recentTrendsBtn" class="cta-button text-white px-4 py-2 rounded-lg">Recent Trends</button>
            </div>
            
            <div class="bg-slate-700 rounded-lg p-4">
                <h4 class="font-semibold mb-2">Community Consensus</h4>
                <p id="communityConsensus" class="mb-4"></p>
                <button id="moreSecretsBtn" class="cta-button text-white px-3 py-2 rounded text-sm">More secrets & tips...</button>
            </div>
        </div>
    </div>
    
    <div id="secretsPopup" class="hidden fixed inset-0 popup-overlay z-50 flex items-center justify-center p-4">
        <div class="popup-content rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Local Secrets & Hidden Gems</h3>
                <button id="closeSecretsPopup" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            <div id="secretsContent"></div>
        </div>
    </div>
    
    <div id="trendsPopup" class="hidden fixed inset-0 popup-overlay z-50 flex items-center justify-center p-4">
        <div class="popup-content rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Recent Trends</h3>
                <button id="closeTrendsPopup" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-semibold mb-4">Sentiment (Last 6 Months)</h4>
                <div id="trendsChart" class="h-48 mb-6"></div>
            </div>
            
            <div id="trendsContent"></div>
        </div>
    </div>
    
    <div id="moreScoresPopup" class="hidden fixed inset-0 popup-overlay z-50 flex items-center justify-center p-4">
        <div class="popup-content rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Detailed Scores & Data</h3>
                <button id="closeMoreScoresPopup" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            <div id="moreScoresContent"></div>
        </div>
    </div>
    
    <div id="signupModal" class="hidden fixed inset-0 popup-overlay z-50 flex items-center justify-center p-4">
        <div class="popup-content rounded-lg p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Join the Waiting List</h3>
                <button id="closeSignupModal" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
            </div>
            
            <p class="mb-6 text-slate-300">
                Join the waiting list for more cities, advanced filters, and our upcoming newsletter with recent location secrets, cool stats, and nomad stories! Coming soon.
            </p>
            
            <div id="clerkSignUp"></div>
        </div>
    </div>
    
    <script>
        // App State
        const appState = {
            selectedPersona: null,
            customizations: {
                budget: null,
                continent: null,
                environment: null
            },
            destinations: [],
            topDestinations: []
        };
        
        // Mock data fallback
        const mockDestination = {
            id: 1,
            city: "Paris",
            country: "France",
            continent: "Europe",
            coords: [48.8566, 2.3522],
            costMonthly: { USD: 2500, EUR: 2300 },
            suitableBudget: {
                "Under ‚Ç¨1K": false,
                "‚Ç¨1K-‚Ç¨2.5K": true,
                "Over ‚Ç¨2.5K": true
            },
            nomadTypeSuitability: {
                explorer: { score: 4.5, summary: "Rich cultural heritage and diverse neighborhoods" },
                workationer: { score: 4.2, summary: "Great coworking spaces and reliable internet" },
                relocator: { score: 4.0, summary: "Excellent infrastructure and healthcare" },
                "remote-professional": { score: 4.3, summary: "Strong business environment" }
            },
            factors: [
                { name: "Cost of Living", score: 3.2, summary: "Moderate to high living costs" },
                { name: "Internet Quality", score: 4.5, summary: "Excellent fiber connectivity" },
                { name: "Safety", score: 4.7, summary: "Very safe for travelers" },
                { name: "Community", score: 4.1, summary: "Active expat community" },
                { name: "Food Scene", score: 4.8, summary: "World-class cuisine" }
            ],
            internet: { speed: 200, stability: 4.5 },
            climate: {
                avgTempRange: "15-25¬∞C",
                airQuality: 4,
                rainy: ["November", "December", "January"],
                bestMonths: ["May", "June", "September", "October"]
            },
            communityPulse: {
                currentSentiment: 4.2,
                hotSecrets: "Visit the covered passages for unique shopping. Try the local markets early morning for best selections."
            },
            popularityTrends: [
                { year: 2022, score: 3.8 },
                { year: 2023, score: 4.1 },
                { year: 2024, score: 4.2 }
            ],
            recentTrends: [
                { month: "March 2025", stars: 4.3, summary: "Great spring weather, fewer crowds" },
                { month: "April 2025", stars: 4.5, summary: "Perfect temperature, outdoor activities" },
                { month: "May 2025", stars: 4.4, summary: "Tourist season starting" },
                { month: "June 2025", stars: 4.2, summary: "Busy but vibrant atmosphere" },
                { month: "July 2025", stars: 3.9, summary: "Hot and crowded" },
                { month: "August 2025", stars: 4.1, summary: "Locals on vacation, quieter" }
            ],
            hiddenGems: [
                { name: "Promenade Plant√©e", summary: "Elevated park built on old railway", tips: "Best visited early morning" },
                { name: "March√© des Enfants Rouges", summary: "Oldest covered market in Paris", tips: "Try the Moroccan stall" }
            ],
            visaHassle: { score: 2.1, summary: "EU passport holders have easy access" },
            workCompatibility: { score: 4.4, summary: "Excellent coworking infrastructure" },
            languageBarriers: { score: 3.2, summary: "English widely spoken in business areas" }
        };
        
        // Questions configuration
        const questions = [
            {
                id: 'budget',
                text: "What's your monthly budget?",
                options: [
                    { value: 'Under ‚Ç¨1K', emoji: 'üí∏', text: 'Under ‚Ç¨1K' },
                    { value: '‚Ç¨1K-‚Ç¨2.5K', emoji: 'üí∞', text: '‚Ç¨1K-‚Ç¨2.5K' },
                    { value: 'Over ‚Ç¨2.5K', emoji: 'ü§ë', text: 'Over ‚Ç¨2.5K' },
                    { value: 'Not a consideration', emoji: 'ü§î', text: 'Not a consideration' }
                ]
            },
            {
                id: 'continent',
                text: 'Which continent?',
                options: [
                    { value: 'Europe', emoji: 'üá™üá∫', text: 'Europe' },
                    { value: 'Asia', emoji: 'üåè', text: 'Asia' },
                    { value: 'South America', emoji: 'üåé', text: 'S. America' },
                    { value: 'Open to all', emoji: 'üó∫Ô∏è', text: 'Open to all' }
                ]
            },
            {
                id: 'environment',
                text: "What's your preferred environment?",
                options: [
                    { value: 'City', emoji: 'üèôÔ∏è', text: 'City' },
                    { value: 'Beach', emoji: 'üèñÔ∏è', text: 'Beach' },
                    { value: 'Mountains', emoji: 'üèîÔ∏è', text: 'Mountains' },
                    { value: 'Either', emoji: 'üîÑ', text: 'Either' }
                ]
            }
        ];
        
        let currentQuestionIndex = 0;
        
        // Utility functions
        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '‚òÖ';
            }
            if (hasHalfStar) {
                stars += '‚òÜ';
            }
            for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) {
                stars += '‚òÜ';
            }
            
            return stars;
        }
        
        function getEmojiFromScore(score, type = 'general') {
            if (type === 'cost') {
                if (score <= 2) return 'üí∏';
                if (score <= 3.5) return 'üí∞';
                return 'üíµ';
            }
            
            if (score >= 4) return '‚ö°Ô∏è';
            if (score >= 3) return 'üö∂‚Äç‚ôÄÔ∏è';
            return 'üê¢';
        }
        
        function getCurrentMonth() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[new Date().getMonth()];
        }
        
        function getNextMonth() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const nextMonthIndex = (new Date().getMonth() + 1) % 12;
            return months[nextMonthIndex];
        }
        
        // Screen transitions
        function showScreen(screenId) {
            document.querySelectorAll('[id$="Screen"]').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        // Persona selection
        document.querySelectorAll('.persona-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                appState.selectedPersona = card.dataset.persona;
                
                const titles = {
                    'explorer': 'üéí The Explorer',
                    'workationer': '‚úàÔ∏è The Workationer',
                    'relocator': 'üè° The Relocator',
                    'remote-professional': 'üíº The Remote Professional'
                };
                
                document.getElementById('personaTitle').textContent = titles[appState.selectedPersona];
                
                setTimeout(() => {
                    showScreen('customizationScreen');
                    showQuestion(0);
                }, 300);
            });
        });
        
        // Question handling
        function showQuestion(index) {
            currentQuestionIndex = index;
            const question = questions[index];
            const container = document.getElementById('questionContainer');
            
            container.innerHTML = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-semibold mb-8">${question.text}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${question.options.map(option => `
                            <div class="option-card bg-slate-700 rounded-lg p-4 cursor-pointer text-center" data-value="${option.value}">
                                <div class="text-3xl mb-2">${option.emoji}</div>
                                <p class="font-medium">${option.text}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', () => {
                    container.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    appState.customizations[question.id] = card.dataset.value;
                    
                    setTimeout(() => {
                        if (index < questions.length - 1) {
                            showQuestion(index + 1);
                        } else {
                            showLoadingAndResults();
                        }
                    }, 500);
                });
            });
        }
        
        // Loading and results
        async function showLoadingAndResults() {
            showScreen('loadingScreen');
            
            await loadDestinationData();
            
            filterAndSortDestinations();
            
            setTimeout(() => {
                showScreen('mapScreen');
                renderMap();
            }, 2000);
        }
        
        // Data loading with validation
        async function loadDestinationData() {
            try {
                const response = await fetch('data/data_sec.json');
                if (!response.ok) throw new Error('Failed to load destinations');
                const data = await response.json();
                appState.destinations = data.filter(dest => {
                    if (!dest.coords || !Array.isArray(dest.coords) || dest.coords.length !== 2 || 
                        isNaN(dest.coords[0]) || isNaN(dest.coords[1])) {
                        console.warn(`Invalid coordinates for destination: ${dest.city || 'Unknown'}`, dest);
                        return false;
                    }
                    return true;
                });
                if (appState.destinations.length === 0) {
                    console.warn('No valid destinations after filtering, using mock data');
                    appState.destinations = [mockDestination];
                }
            } catch (error) {
                console.warn('Error loading destinations, using mock data:', error.message);
                appState.destinations = [mockDestination];
            }
        }
        
        // Filtering and sorting logic
        function filterAndSortDestinations() {
            let filtered = appState.destinations.filter(dest => {
                if (appState.customizations.budget !== 'Not a consideration') {
                    const budgetKey = appState.customizations.budget;
                    if (dest.suitableBudget && !dest.suitableBudget[budgetKey]) {
                        return false;
                    }
                }
                
                if (appState.customizations.continent !== 'Open to all' && 
                    dest.continent !== appState.customizations.continent) {
                    return false;
                }
                
                return true;
            });
            
            filtered.sort((a, b) => {
                const scoreA = calculateAggregateScore(a);
                const scoreB = calculateAggregateScore(b);
                return scoreB - scoreA;
            });
            
            appState.topDestinations = filtered.slice(0, 3);
        }
        
        function calculateAggregateScore(destination) {
            const personaScore = destination.nomadTypeSuitability?.[appState.selectedPersona]?.score || 3;
            const factorsAvg = destination.factors?.reduce((sum, f) => sum + f.score, 0) / (destination.factors?.length || 1) || 3;
            const sentimentScore = destination.communityPulse?.currentSentiment || 3;
            
            return (personaScore + factorsAvg + sentimentScore) / 3;
        }
        
        // Map rendering
        function renderMap() {
            const svg = d3.select('#worldMap');
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            svg.attr('width', width).attr('height', height);
            
            const projection = d3.geoNaturalEarth1()
                .scale(200)
                .translate([width / 2, height / 2]);
            
            const path = d3.geoPath().projection(projection);
            
            d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').then(world => {
                svg.selectAll('.country')
                    .data(topojson.feature(world, world.objects.countries).features)
                    .enter().append('path')
                    .attr('class', 'country')
                    .attr('d', path)
                    .attr('fill', '#334155')
                    .attr('stroke', '#1e293b')
                    .attr('stroke-width', 0.5);
                
                if (appState.topDestinations.length > 0) {
                    const centroid = calculateCentroid(appState.topDestinations);
                    projection.center([centroid.lon, centroid.lat]).scale(300);
                    
                    svg.selectAll('.country').attr('d', path);
                    addMarkers(svg, projection);
                } else {
                    console.warn('No valid destinations to display on map');
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .attr('fill', '#e2e8f0')
                        .text('No destinations available to display');
                }
            }).catch(error => {
                console.error('Error loading world map data:', error);
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#e2e8f0')
                    .text('Error loading map data');
            });
        }
        
        // Calculate centroid with robust handling
        function calculateCentroid(destinations) {
            if (!destinations || destinations.length === 0) {
                console.warn('No destinations provided for centroid calculation, returning default');
                return { lat: 0, lon: 0 };
            }
            
            const validDestinations = destinations.filter(dest => {
                if (!dest.coords || !Array.isArray(dest.coords) || dest.coords.length !== 2 || 
                    isNaN(dest.coords[0]) || isNaN(dest.coords[1])) {
                    console.warn(`Invalid coordinates for destination: ${dest.city || 'Unknown'}`, dest);
                    return false;
                }
                return true;
            });
            
            if (validDestinations.length === 0) {
                console.warn('No valid destinations for centroid calculation, returning default');
                return { lat: 0, lon: 0 };
            }
            
            const avgLat = validDestinations.reduce((sum, dest) => sum + dest.coords[0], 0) / validDestinations.length;
            const avgLon = validDestinations.reduce((sum, dest) => sum + dest.coords[1], 0) / validDestinations.length;
            return { lat: avgLat, lon: avgLon };
        }
        
        // Add markers with validation
        function addMarkers(svg, projection) {
            const markers = svg.selectAll('.map-marker')
                .data(appState.topDestinations.filter(dest => {
                    if (!dest.coords || !Array.isArray(dest.coords) || dest.coords.length !== 2 || 
                        isNaN(dest.coords[0]) || isNaN(dest.coords[1])) {
                        console.warn(`Skipping marker for ${dest.city || 'Unknown'}: invalid coordinates`, dest);
                        return false;
                    }
                    return true;
                }))
                .enter().append('g')
                .attr('class', 'marker-group');
            
            markers.append('circle')
                .attr('cx', d => projection([d.coords[1], d.coords[0]])[0])
                .attr('cy', d => projection([d.coords[1], d.coords[0]])[1])
                .attr('class', 'map-marker')
                .attr('r', 8)
                .on('click', (event, d) => showCityPopup(d));
            
            markers.append('text')
                .attr('x', d => projection([d.coords[1], d.coords[0]])[0])
                .attr('y', d => projection([d.coords[1], d.coords[0]])[1] - 15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#e2e8f0')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text(d => d.city);
        }
        
        // City popup
        function showCityPopup(destination) {
            const popup = document.getElementById('cityPopup');
            
            document.getElementById('cityTitle').textContent = `${destination.city}, ${destination.country}`;
            
            const costRange = destination.costMonthly?.EUR || destination.costMonthly?.USD || 2000;
            const minCost = Math.round(costRange * 0.75);
            const maxCost = Math.round(costRange * 1.25);
            const costEmoji = getEmojiFromScore(destination.factors?.find(f => f.name.includes('Cost'))?.score || 3, 'cost');
            document.getElementById('monthlyCost').innerHTML = `${costEmoji} ‚Ç¨${minCost} - ‚Ç¨${maxCost}`;
            
            const internetSpeed = destination.internet?.speed || 100;
            const internetStability = destination.internet?.stability || 4;
            const stabilityEmoji = getEmojiFromScore(internetStability);
            const stars = renderStars(internetStability);
            document.getElementById('internetInfo').innerHTML = `${internetSpeed} Mbps ${stabilityEmoji} ${stars}`;
            
            const currentMonth = getCurrentMonth();
            const nextMonth = getNextMonth();
            const climate = destination.climate || {};
            const isRainyPeriod = climate.rainy?.includes(currentMonth) || climate.rainy?.includes(nextMonth);
            const isBestPeriod = climate.bestMonths?.includes(currentMonth) || climate.bestMonths?.includes(nextMonth);
            const weatherEmoji = isBestPeriod ? '‚òÄÔ∏è' : (isRainyPeriod ? 'üåßÔ∏è' : '‚õÖ');
            const tempRange = climate.avgTempRange || '20-25¬∞C';
            const airQuality = climate.airQuality || 4;
            document.getElementById('climateInfo').innerHTML = `${weatherEmoji} (Avg: ${tempRange}, Air Quality: ${airQuality}/5)`;
            
            document.getElementById('communityConsensus').textContent = destination.communityPulse?.hotSecrets || "Great destination for digital nomads.";
            
            renderNomadsChart(destination.popularityTrends || []);
            
            popup.currentDestination = destination;
            
            popup.classList.remove('hidden');
        }
        
        function renderNomadsChart(trends) {
            const container = d3.select('#nomadsChart');
            container.selectAll('*').remove();
            
            if (!trends.length) return;
            
            const margin = { top: 10, right: 10, bottom: 20, left: 10 };
            const width = 250 - margin.left - margin.right;
            const height = 100 - margin.bottom - margin.top;
            
            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            const x = d3.scaleLinear()
                .domain(d3.extent(trends, d => d.year))
                .range([0, width]);
            
            const y = d3.scaleLinear()
                .domain([0, 5])
                .range([height, 0]);
            
            const line = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.score))
                .curve(d3.curveCardinal);
            
            g.append('path')
                .datum(trends)
                .attr('fill', 'none')
                .attr('stroke', '#6366f1')
                .attr('stroke-width', 2)
                .attr('d', line);
            
            g.selectAll('.dot')
                .data(trends)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', d => x(d.year))
                .attr('cy', d => y(d.score))
                .attr('r', 3)
                .attr('fill', '#6366f1');
        }
        
        function renderTrendsChart(trends) {
            const container = d3.select('#trendsChart');
            container.selectAll('*').remove();
            
            if (!trends.length) return;
            
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };
            const width = 400 - margin.left - margin.right;
            const height = 150 - margin.bottom - margin.top;
            
            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(trends.map((d, i) => i))
                .range([0, width])
                .padding(0.1);
            
            const y = d3.scaleLinear()
                .domain([0, 5])
                .range([height, 0]);
            
            const line = d3.line()
                .x((d, i) => x(i) + x.bandwidth() / 2)
                .y(d => y(d.stars))
                .curve(d3.curveCardinal);
            
            g.append('path')
                .datum(trends)
                .attr('fill', 'none')
                .attr('stroke', '#6366f1')
                .attr('stroke-width', 2)
                .attr('d', line);
            
            g.selectAll('.dot')
                .data(trends)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', (d, i) => x(i) + x.bandwidth() / 2)
                .attr('cy', d => y(d.stars))
                .attr('r', 4)
                .attr('fill', '#6366f1');
            
            g.selectAll('.x-label')
                .data(trends)
                .enter().append('text')
                .attr('class', 'x-label')
                .attr('x', (d, i) => x(i) + x.bandwidth() / 2)
                .attr('y', height + 15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#e2e8f0')
                .attr('font-size', '10px')
                .text(d => d.month.split(' ')[0]);
        }
        
        // Popup handlers
        document.getElementById('closeCityPopup').addEventListener('click', () => {
            document.getElementById('cityPopup').classList.add('hidden');
        });
        
        document.getElementById('moreSecretsBtn').addEventListener('click', () => {
            const destination = document.getElementById('cityPopup').currentDestination;
            showSecretsPopup(destination);
        });
        
        document.getElementById('recentTrendsBtn').addEventListener('click', () => {
            const destination = document.getElementById('cityPopup').currentDestination;
            showTrendsPopup(destination);
        });
        
        document.getElementById('moreScoresBtn').addEventListener('click', () => {
            const destination = document.getElementById('cityPopup').currentDestination;
            showMoreScoresPopup(destination);
        });
        
        function showSecretsPopup(destination) {
            const popup = document.getElementById('secretsPopup');
            const content = document.getElementById('secretsContent');
            
            const hiddenGems = destination.hiddenGems || [];
            content.innerHTML = hiddenGems.map(gem => `
                <div class="mb-4 p-4 bg-slate-700 rounded-lg">
                    <h4 class="font-bold text-lg mb-2">${gem.name}</h4>
                    <p class="text-sm text-slate-400">${gem.tips}</p>
                </div>
            `).join('') || '<p>No hidden gems available yet.</p>';
            
            popup.classList.remove('hidden');
        }
        
        function showTrendsPopup(destination) {
            const popup = document.getElementById('trendsPopup');
            const content = document.getElementById('trendsContent');
            
            const trends = destination.recentTrends || [];
            
            renderTrendsChart(trends);
            
            content.innerHTML = trends.map(trend => `
                <div class="mb-3 p-3 bg-slate-700 rounded">
                    <div class="flex justify-between items-center">
                        <strong>${trend.month}</strong>
                        <span>${renderStars(trend.stars)}</span>
                    </div>
                    <p class="text-sm text-slate-300 mt-1">${trend.summary}</p>
                </div>
            `).join('') || '<p>No recent trends data available.</p>';
            
            popup.classList.remove('hidden');
        }
        
        function showMoreScoresPopup(destination) {
            const popup = document.getElementById('moreScoresPopup');
            const content = document.getElementById('moreScoresContent');
            
            const factors = destination.factors || [];
            const visa = destination.visaHassle || {};
            const work = destination.workCompatibility || {};
            const language = destination.languageBarriers || {};
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-3">General Factors</h4>
                        ${factors.map(factor => `
                            <div class="mb-3 p-3 bg-slate-700 rounded">
                                <div class="flex justify-between items-center">
                                    <strong>${factor.name}</strong>
                                    <span>${renderStars(factor.score)}</span>
                                </div>
                                <p class="text-sm text-slate-300 mt-1">${factor.summary}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div>
                        <h4 class="font-semibold mb-3">Additional Considerations</h4>
                        
                        <div class="mb-3 p-3 bg-slate-700 rounded">
                            <div class="flex justify-between items-center">
                                <strong>Visa Hassle</strong>
                                <span>${renderStars(visa.score || 3)}</span>
                            </div>
                            <p class="text-sm text-slate-300 mt-1">${visa.summary || 'Visa requirements vary by nationality'}</p>
                        </div>
                        
                        <div class="mb-3 p-3 bg-slate-700 rounded">
                            <div class="flex justify-between items-center">
                                <strong>Work Compatibility</strong>
                                <span>${renderStars(work.score || 4)}</span>
                            </div>
                            <p class="text-sm text-slate-300 mt-1">${work.summary || 'Good infrastructure for remote work'}</p>
                        </div>
                        
                        <div class="mb-3 p-3 bg-slate-700 rounded">
                            <div class="flex justify-between items-center">
                                <strong>Language Barriers</strong>
                                <span>${renderStars(language.score || 3)}</span>
                            </div>
                            <p class="text-sm text-slate-300 mt-1">${language.summary || 'English commonly spoken in tourist areas'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            popup.classList.remove('hidden');
        }
        
        // Close popup handlers
        document.getElementById('closeSecretsPopup').addEventListener('click', () => {
            document.getElementById('secretsPopup').classList.add('hidden');
        });
        
        document.getElementById('closeTrendsPopup').addEventListener('click', () => {
            document.getElementById('trendsPopup').classList.add('hidden');
        });
        
        document.getElementById('closeMoreScoresPopup').addEventListener('click', () => {
            document.getElementById('moreScoresPopup').classList.add('hidden');
        });
        
        // Sign-up modal
        document.getElementById('signupCTA').addEventListener('click', () => {
            document.getElementById('signupModal').classList.remove('hidden');
        });
        
        document.getElementById('closeSignupModal').addEventListener('click', () => {
            document.getElementById('signupModal').classList.add('hidden');
        });
        
        // Close popups when clicking overlay
        document.querySelectorAll('.popup-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.add('hidden');
                }
            });
        });
        
        // Initialize Clerk
        function initializeClerk() {
            if (window.Clerk) {
                window.Clerk.load({
                    publishableKey: 'pk_test_aG90LWNhdC04MS5jbGVyay5hY2NvdW50cy5kZXYk'
                }).then(() => {
                    const clerkDiv = document.getElementById('clerkSignUp');
                    if (clerkDiv && !clerkDiv.hasChildNodes()) {
                        window.Clerk.mountSignUp(clerkDiv, {
                            afterSignUpUrl: '#success',
                            signInUrl: '#signin'
                        });
                    }
                }).catch(error => {
                    console.error('Clerk initialization failed:', error);
                    document.getElementById('clerkSignUp').innerHTML = `
                        <form id="fallbackSignup" class="space-y-4">
                            <input type="email" placeholder="Enter your email" 
                                   class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-indigo-500 focus:outline-none"
                                   required>
                            <button type="submit" class="w-full cta-button text-white py-3 rounded-lg font-medium">
                                Join Waiting List
                            </button>
                        </form>
                    `;
                    
                    document.getElementById('fallbackSignup').addEventListener('submit', (e) => {
                        e.preventDefault();
                        document.getElementById('signupModal').innerHTML = `
                            <div class="popup-content rounded-lg p-6 max-w-md w-full text-center">
                                <h3 class="text-xl font-bold mb-4">You're on the list!</h3>
                                <p class="text-slate-300 mb-6">We'll email you when more features launch.</p>
                                <button onclick="document.getElementById('signupModal').classList.add('hidden')" 
                                        class="cta-button text-white px-6 py-2 rounded-lg">
                                    Close
                                </button>
                            </div>
                        `;
                    });
                });
            }
        }
        
        // Responsive handling
        window.addEventListener('resize', () => {
            if (!document.getElementById('mapScreen').classList.contains('hidden')) {
                renderMap();
            }
        });
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('welcomeScreen');
            initializeClerk();
            
            if (typeof gtag !== 'undefined') {
                gtag('event', 'page_view', {
                    page_title: 'Find Your Next Bali',
                    page_location: window.location.href
                });
            }
        });
    </script>
</body>
</html>
