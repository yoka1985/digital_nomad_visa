<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Where to Next? | Find Your Perfect Visa to Live and Work Abroad</title>
    <meta name="description" content="Find your perfect visa. Compare 74+ visa options based on your income, lifestyle, and bureaucracy tolerance. Make an informed decision for your expat or nomad journey." />
    <meta name="keywords" content="digital nomad visa, expat life, move abroad, remote work, long-stay visa, lifestyle design, global living, find a country, visa requirements 2025" />
    
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://nomadvisa.help/" />
    <meta property="og:title" content="Where to Next? | Find Your Perfect Visa to Live Abroad" />
    <meta property="og:description" content="Compare visa pathways based on your unique lifestyle and financial profile. Your informed journey starts here." />
    <meta property="og:image" content="https://nomadvisa.help/images/og-image.jpg" />
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://nomadvisa.help/" />
    <meta property="twitter:title" content="Where to Next? | Find Your Perfect Visa" />
    <meta property="twitter:description" content="Filter over 74 visa options to find the one that truly matches your lifestyle and needs. Updated for 2025." />
    <meta property="twitter:image" content="https://nomadvisa.help/images/og-image.jpg" />
    <link rel="canonical" href="https://nomadvisa.help/" />
    <meta name="geo.region" content="Global" />
    <meta name="geo.placename" content="Worldwide" />
    
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script" />
    <link rel="preload" href="./data/data.json" as="fetch" crossorigin />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6N573S8D8S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', { 'analytics_storage': 'denied' });
        function initGoogleAnalytics() {
            gtag('consent', 'update', { 'analytics_storage': 'granted' });
            gtag('js', new Date());
            gtag('config', 'G-6N573S8D8S');
        }
    </script>
    
    <style>
        body { background-color: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #334155; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 10px; }
        details > summary { list-style: none; cursor: pointer;}
        details > summary::-webkit-details-marker { display: none; }
        details summary .plus-minus::before { content: '+'; }
        details[open] summary .plus-minus::before { content: '‚àí'; }
        .main-content { transition: filter 0.5s ease-in-out, transform 0.5s ease-in-out; }
        .funnel-active .main-content { filter: blur(8px); transform: scale(1.02); pointer-events: none; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        @keyframes funnel-overlay-fade-in { from { opacity: 0; } to { opacity: 1; } }
        .funnel-overlay-enter { animation: funnel-overlay-fade-in 0.5s ease forwards; }
        @keyframes funnel-content-slide-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .funnel-content-enter { animation: funnel-content-slide-in 0.5s ease 0.2s backwards; }
        @keyframes funnel-step-fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .funnel-step-enter { animation: funnel-step-fade 0.4s ease forwards; }
        @keyframes card-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-card-in { animation: card-fade-in 0.4s ease-out forwards; }
        @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-content-slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-enter { animation: modal-fade-in 0.3s ease-out forwards; }
        .modal-content-enter { animation: modal-content-slide-up 0.3s ease-out forwards; }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- DATA, CONSTANTS & UTILS ---
        const COUNTRY_CODE_MAP = { 'Andorra': 'AD', 'Argentina': 'AR', 'Albania': 'AL', 'Australia': 'AU', 'Austria': 'AT', 'Brazil': 'BR', 'Bulgaria': 'BG', 'Canada': 'CA', 'Colombia': 'CO', 'Croatia': 'HR', 'Cyprus': 'CY', 'Czech Republic': 'CZ', 'Estonia': 'EE', 'Germany': 'DE', 'Georgia': 'GE', 'Greece': 'GR', 'Hungary': 'HU', 'Iceland': 'IS', 'Indonesia': 'ID', 'Italy': 'IT', 'Japan': 'JP', 'Latvia': 'LV', 'Malaysia': 'MY', 'Malta': 'MT', 'Mauritius': 'MU', 'Mexico': 'MX', 'Montenegro': 'ME', 'Norway': 'NO', 'Panama': 'PA', 'Philippines': 'PH', 'Portugal': 'PT', 'Romania': 'RO', 'South Africa': 'ZA', 'South Korea': 'KR', 'Spain': 'ES', 'Sri Lanka': 'LK', 'Thailand': 'TH', 'UAE (Dubai)': 'AE', 'United Kingdom': 'GB', 'United States': 'US' };
        const EU_COUNTRIES = ['Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden'];
        const incomeLevels = [ { label: "Any", value: "any", userIncomeForMatch: null }, { label: "Zero Proof", value: "0", userIncomeForMatch: 0 }, { label: "< $2k", value: "1-1999", userIncomeForMatch: 1999 }, { label: "$2k-4k", value: "2000-3999", userIncomeForMatch: 3999 }, { label: "$4k+", value: "4000+", userIncomeForMatch: Infinity } ];
        const durationOptions = [ { label: "Any", months: 0 }, { label: "6m+", months: 6 }, { label: "1yr+", months: 12 }, { label: "2yr+", months: 24 }];
        const LIFESTYLE_MAP = {
          "The Architecture of Community": "Community & Social Life",
          "The Friction of Life Admin": "Low Bureaucracy",
          "The Third Place Ecosystem": "Good Remote Work Scene",
          "The Baseline of Felt Safety": "Safety & Security",
          "The Path to Permanence": "Long-Term Options"
        };
        const lifestyleOptions = Object.keys(LIFESTYLE_MAP);

        function nationalityToClusters(nationality) {
            if (EU_COUNTRIES.includes(nationality)) return ['EU Citizen'];
            if (['United States', 'Canada', 'Australia', 'New Zealand', 'Japan', 'South Korea'].includes(nationality)) return ['Non-EU/EEA Nationals', 'OECD Nationals', 'Special Eligibility'];
            if (['United Kingdom'].includes(nationality)) return ['Non-EU/EEA Nationals', 'Special Eligibility'];
            return ['Non-EU/EEA Nationals', 'All Nationalities', 'Country-Specific Nationals'];
        };
        function getCountryFlagEmoji(countryName) {
            const countryCode = COUNTRY_CODE_MAP[countryName];
            if (!countryCode) return 'üè≥Ô∏è';
            return String.fromCodePoint(...[...countryCode.toUpperCase()].map(char => char.charCodeAt(0) + 127397));
        };
        function getGuideDetails(countryName, visaName) {
             if (['Spain', 'Croatia', 'Bulgaria', 'Thailand', 'Georgia','Portugal'].includes(countryName)) {
                 return { hasGuide: true, isComingSoon: true };
             }
             return { hasGuide: false };
        }
        function getScoreAttributes(score, type = 'standard') {
            const invertedDesc = ['Very Low', 'Low', 'Moderate', 'High', 'Very High'];
            const colors = ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444' ];
            if (score === null || score === undefined || score < 1 || score > 5) {
                return { description: 'N/A', color: '#64748b' };
            }
            const color = colors[score - 1];
            let description = invertedDesc[score - 1];
            const displayColor = (type === 'bureaucracy_level' || type === 'social_security_liability') ? color : [...colors].reverse()[score - 1];

            if (type === 'bureaucracy_level') {
                description = `${description} Complexity`;
            }
            return { description, color: displayColor };
        };

        // --- ALL COMPONENTS ---
        
        function GuidedFunnel({ step, onAdvance, onSkip, setters, values, allCountries, matchingCount }) {
            const handleSelect = (setter, value, advance = true) => {
                setter(value);
                if(advance) onAdvance();
            };
            const renderStepContent = () => {
                const stepClasses = "w-full max-w-md mx-auto funnel-step-enter";
                switch (step) {
                    case 1:
                        return (
                            <div className={stepClasses}>
                                <h2 className="text-3xl font-bold text-white mb-4 text-center">Let's Start With Your Nationality</h2>
                                <NationalitySelector selectedNationality={values.nationality} onSelectNationality={(val) => handleSelect(setters.nationality, val)} allCountries={allCountries} />
                            </div>
                        );
                    case 2:
                        return (
                            <div className={stepClasses}>
                                <h2 className="text-3xl font-bold text-white mb-4 text-center">What's your estimated monthly income?</h2>
                                <div className="flex flex-wrap gap-3 justify-center">
                                  {incomeLevels.map(level => (
                                       <button key={level.value} onClick={() => handleSelect(setters.income, level.value)}
                                               className={`px-6 py-3 text-lg rounded-lg transition-all transform hover:scale-105 bg-slate-700 hover:bg-slate-600 text-slate-200`}>
                                           {level.label}
                                       </button>
                                   ))}
                               </div>
                            </div>
                        );
                    case 3:
                         return (
                            <div className={stepClasses}>
                                <h2 className="text-3xl font-bold text-white mb-4 text-center">How long do you plan to stay?</h2>
                                <div className="flex flex-wrap gap-3 justify-center">
                                   {durationOptions.map(opt => (
                                       <button key={opt.label} onClick={() => handleSelect(setters.duration, opt.months)}
                                           className={`px-6 py-3 text-lg rounded-lg transition-all transform hover:scale-105 bg-slate-700 hover:bg-slate-600 text-slate-200`}>
                                           {opt.label}
                                       </button>
                                   ))}
                               </div>
                            </div>
                        );
                    default: return null;
                }
            };
            return (
                <div className="fixed inset-0 z-50 bg-slate-900/80 flex flex-col justify-center items-center p-4 funnel-overlay-enter">
                    <div className="funnel-content-enter w-full">
                        {renderStepContent()}
                        <div className="text-center mt-8">
                            <p className="text-purple-300 text-lg transition-opacity duration-300 h-8">
                                {matchingCount !== null ? `Found ${matchingCount} matching visa options...` : ' '}
                            </p>
                            <button onClick={onSkip} className="mt-4 text-slate-400 hover:text-white transition underline">
                                Skip for now
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function NationalitySelector({ selectedNationality, onSelectNationality, allCountries }) {
            const [searchTerm, setSearchTerm] = React.useState("");
            const [isOpen, setIsOpen] = React.useState(false);
            const popularCountries = ['United States', 'United Kingdom', 'Canada', 'Germany', 'Australia', 'Brazil', 'India', 'South Africa'].sort();
            const popularSet = new Set(popularCountries);
            const otherCountries = allCountries.filter(c => !popularSet.has(c));

            return (
                <div>
                    <div className="relative">
                        <button onClick={() => setIsOpen(!isOpen)} className="w-full p-4 bg-slate-700 border-2 border-slate-600 rounded-lg shadow-lg text-left flex justify-between items-center text-lg text-white" >
                            <span>{selectedNationality ? `${getCountryFlagEmoji(selectedNationality)} ${selectedNationality}` : '-- Select your country --'}</span>
                            <span className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
                        </button>
                        {isOpen && (
                            <div className="absolute top-full left-0 right-0 mt-2 bg-slate-700 border border-slate-600 rounded-lg shadow-lg z-20">
                                <input type="text" placeholder="Search..." className="w-full p-3 bg-slate-800 text-white border-b border-slate-600 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                <ul className="max-h-60 overflow-y-auto custom-scrollbar text-white">
                                    <li className="px-2 pt-2 pb-1 text-xs text-slate-400 font-bold uppercase">Popular</li>
                                    {popularCountries.filter(c => c.toLowerCase().includes(searchTerm.toLowerCase())).map(c => <li key={c} onClick={() => { onSelectNationality(c); setIsOpen(false); }} className="p-3 hover:bg-purple-600 cursor-pointer flex items-center gap-2"><span>{getCountryFlagEmoji(c)}</span><span>{c}</span></li>)}
                                    <hr className="border-slate-500 my-1"/>
                                    {otherCountries.filter(c => c.toLowerCase().includes(searchTerm.toLowerCase())).map(c => <li key={c} onClick={() => { onSelectNationality(c); setIsOpen(false); }} className="p-3 hover:bg-purple-600 cursor-pointer flex items-center gap-2"><span>{getCountryFlagEmoji(c)}</span><span>{c}</span></li>)}
                                </ul>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        function Navbar({ onLinkClick }) {
            const [isOpen, setIsOpen] = React.useState(false);
            const links = [ { label: 'üí° About', id: 'about' }, { label: '‚öôÔ∏è How to Use', id: 'howToUse' }, ];
            return (
                <nav className="bg-slate-800/50 backdrop-blur-sm rounded-xl p-4 sticky top-4 z-40 mb-8 max-w-6xl mx-auto">
                    <div className="flex items-center justify-between">
                        <div className="text-xl font-bold text-white">Where to Next?</div>
                        <div className="hidden md:flex items-center space-x-4">
                            {links.map(link => <button key={link.id} onClick={() => onLinkClick(link.id)} className="text-slate-300 hover:text-purple-400 transition">{link.label}</button>)}
                             <a href="./world.html" target="_blank" className="bg-sky-500 hover:bg-sky-400 text-white font-bold py-2 px-4 rounded-lg transition-all transform hover:scale-105 shadow-md shadow-sky-500/30">üó∫Ô∏è View on Map</a>
                        </div>
                        <div className="md:hidden">
                            <button onClick={() => setIsOpen(!isOpen)} className="text-white focus:outline-none">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16"}></path></svg>
                            </button>
                        </div>
                    </div>
                    {isOpen && (
                        <div className="md:hidden mt-4 space-y-2">
                            {links.map(link => <button key={link.id} onClick={() => {onLinkClick(link.id); setIsOpen(false);}} className="block w-full text-left py-2 px-4 text-slate-300 hover:bg-slate-700 rounded">{link.label}</button>)}
                            <a href="./world.html" target="_blank" className="block w-full text-center mt-2 bg-sky-500 hover:bg-sky-400 text-white font-bold py-2 px-4 rounded-lg transition">üó∫Ô∏è View on Map</a>
                        </div>
                    )}
                </nav>
            );
        }

        const ComingSoonPopover = () => (
            <div className="absolute bottom-full left-1/2 mb-2 w-48 bg-slate-900 border border-slate-600 rounded-lg shadow-2xl p-3 z-30 animate-fade-in-up text-center">
                 <h4 className="font-bold text-slate-300">Guide Coming Soon!</h4>
                 <p className="text-xs text-slate-400">In-depth guide is in the works.</p>
            </div>
        );

        function VisaCard({ country, visa, onViewDetails }) {
            const [isHovering, setIsHovering] = React.useState(false);
            if (!visa) return null;
            const { description, color } = getScoreAttributes(country.ratings?.bureaucracy_level, 'bureaucracy_level');
            const guideDetails = getGuideDetails(country.country_name, visa.visa_name);

            return (
                <div className="bg-slate-800 shadow-xl rounded-lg p-5 flex flex-col justify-between transition-all hover:shadow-purple-500/30 hover:scale-[1.02] duration-300 animate-card-in">
                    <div>
                        <h3 className="text-xl font-bold text-purple-400 mb-2 min-h-[3.5rem]">
                            {getCountryFlagEmoji(country.country_name)} {country.country_name} ‚Äì <span className="font-normal text-slate-300">{visa.visa_name}</span>
                        </h3>
                        <div className="space-y-3 text-sm mb-4 text-slate-300">
                            <p>‚è≥<span className="font-semibold"> Duration:</span> {visa.visa_length_months ? `${visa.visa_length_months} months` : 'N/A'}</p>
                            <p>üí∏<span className="font-semibold"> Income:</span> {visa.income_requirement_usd_month != null ? `~$${visa.income_requirement_usd_month.toLocaleString()}/mo` : 'Not specified'}</p>
                            <p className="flex items-center gap-2">
                                <span className="font-semibold">ü§Ø Bureaucracy:</span>
                                <span className="font-bold" style={{ color: color }}>{description}</span>
                            </p>
                        </div>
                    </div>
                    <div className="mt-auto pt-4 border-t border-slate-700/50 flex items-stretch gap-2">
                        {guideDetails.hasGuide && (
                             <div className="relative flex-1" onMouseEnter={() => setIsHovering(true)} onMouseLeave={() => setIsHovering(false)}>
                                 <button
                                     disabled
                                     className={`w-full h-full flex items-center justify-center font-semibold py-2 px-3 rounded-lg transition text-white text-sm bg-slate-600 cursor-not-allowed`}>
                                     üìö Guide
                                 </button>
                                 {isHovering && guideDetails.isComingSoon && <ComingSoonPopover />}
                             </div>
                        )}
                        <button className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition" onClick={() => onViewDetails({ ...country, visas: [visa] })}>
                            View Full Details
                        </button>
                    </div>
                </div>
            );
        };

        const ScoreDetailItem = ({ label, score, explanation }) => {
            if (score === null || score === undefined) return null;
            return (
                <details className="bg-slate-900/50 rounded-lg overflow-hidden">
                    <summary className="p-4 cursor-pointer">
                        <div className="flex justify-between items-center mb-2">
                            <span className="font-semibold text-slate-200">{label}</span>
                            <span className="plus-minus text-purple-400 text-xl font-semibold"></span>
                        </div>
                        <div className="w-full bg-slate-700 rounded-full h-2.5">
                            <div className="bg-purple-500 h-2.5 rounded-full" style={{ width: `${score * 20}%`}}></div>
                        </div>
                    </summary>
                    <div className="border-t border-slate-700/50 px-4 pt-3 pb-4">
                        <p className="text-sm text-slate-300 italic">{explanation}</p>
                    </div>
                </details>
            );
        };
        
        function DetailsModal({ country, onClose }) {
            const visa = country.visas?.[0];
            if (!visa) return null;

            const lifestyleRatings = Object.keys(country.ratings || {})
                .filter(key => typeof country.ratings[key] === 'object')
                .map(key => ({
                    key,
                    name: LIFESTYLE_MAP[key] || key,
                    score: country.ratings[key].score,
                    explanation: country.ratings[key].explanation
                }));

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4 modal-enter" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar modal-content-enter" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-start pb-4 border-b border-slate-700 mb-6">
                            <div>
                                <h2 className="text-3xl font-bold text-purple-400 flex items-center gap-4">
                                    <span>{getCountryFlagEmoji(country.country_name)} {country.country_name}</span>
                                </h2>
                                <p className="text-slate-400 mt-1">{visa.visa_name}</p>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-4xl font-light">&times;</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <div className="bg-slate-900/50 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-slate-200 mb-3">üîë Key Information</h3>
                                    <div className="space-y-2 text-sm text-slate-300">
                                        <p><strong>Duration:</strong> {visa.visa_length_months ? `${visa.visa_length_months} months` : "N/A"}</p>
                                        <p><strong>Cost (est.):</strong> {visa.visa_cost_usd ? `$${visa.visa_cost_usd}` : 'N/A'}</p>
                                        <p><strong>Minimum Income:</strong> {visa.income_requirement_usd_month != null ? `$${visa.income_requirement_usd_month.toLocaleString()}/month` : 'Not specified'}</p>
                                        <p><strong>Eligible Nationalities:</strong> {visa.eligible_citizens_cluster}</p>
                                        {visa.remarks && <p className="pt-2 border-t border-slate-700 mt-2"><strong>Note:</strong> {visa.remarks}</p>}
                                        {visa.link_source && <a href={visa.link_source} target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline mt-2 block">Official Source ‚Üí</a>}
                                    </div>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <h3 className="text-xl font-semibold text-slate-100 mb-2">Lifestyle Scores</h3>
                                {lifestyleRatings.map(rating => (
                                     <ScoreDetailItem key={rating.key} label={rating.name} score={rating.score} explanation={rating.explanation} />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function InfoModal({ data, onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4 modal-enter" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar modal-content-enter" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center pb-4 border-b border-slate-700">
                            <h2 className="text-2xl font-bold text-purple-400">{data.title}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-3xl font-light">&times;</button>
                        </div>
                        <div className="mt-6 text-slate-300 text-sm space-y-4 leading-relaxed" dangerouslySetInnerHTML={{ __html: data.content }}></div>
                    </div>
                </div>
            );
        };

        // --- CORRECT, TWO-COLUMN CONVERTKIT MODAL ---
        function ConvertKitModal({ show, onClose }) {
            if (!show) return null;
        
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4 sm:py-[10vh] modal-enter" onClick={onClose}>
                    <div className="bg-slate-800 rounded-lg shadow-2xl border border-purple-500/50 overflow-hidden relative w-full max-w-md md:max-w-lg lg:max-w-3xl max-h-[90vh] modal-content-enter" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-2 right-3 text-slate-400 hover:text-white text-3xl font-light z-20">&times;</button>
                        
                        <form onSubmit={e => { e.preventDefault(); onClose(); /* Acknowledge submission */ }}>
                            <div className="flex flex-col md:flex-row">
                                <div className="formkit-column bg-slate-900 relative flex flex-col justify-center text-center p-8 md:w-1/2" style={{ backgroundImage: 'url("https://images.unsplash.com/photo-1519699047748-605c05a22a7a?auto=format&fit=crop&q=80")', backgroundSize: 'cover', backgroundPosition: 'center' }}>
                                    <div className="absolute inset-0 bg-black/50 z-10"></div>
                                    <div className="relative z-10">
                                        <h2 className="text-2xl font-bold text-white mb-2">Stay One Step Ahead</h2>
                                        <p className="text-sm text-slate-300 opacity-90">Get visa updates, expat intel, and nomad discoveries. Join the waitlist!</p>
                                    </div>
                                </div>
                                
                                <div className="formkit-column p-8 flex flex-col justify-center md:w-1/2">
                                    <div className="space-y-4">
                                        <div className="formkit-field">
                                            <input
                                                className="w-full p-3 bg-slate-700 text-slate-200 border border-slate-600 rounded-md focus:outline-none focus:border-purple-400 transition"
                                                name="email_address"
                                                aria-label="Email Address"
                                                placeholder="Email Address"
                                                required
                                                type="email"
                                            />
                                        </div>
                                        <div className="formkit-field">
                                            <input
                                                className="w-full p-3 bg-slate-700 text-slate-200 border border-slate-600 rounded-md focus:outline-none focus:border-purple-400 transition"
                                                aria-label="Any feedback on the site? (optional)"
                                                name="fields[feedback]"
                                                placeholder="Any feedback on the site? (optional)"
                                                type="text"
                                            />
                                        </div>
                                        <button
                                            type="submit"
                                            className="w-full p-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md transition flex items-center justify-center"
                                        >
                                            <span>Keep Me in the Loop</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }
        
        function Footer({onLinkClick}) {
            return (
                <footer className="text-center mt-12 py-6 border-t border-slate-700">
                    <div className="flex justify-center items-center flex-wrap gap-x-4 gap-y-2 text-sm text-slate-400">
                        <button onClick={() => onLinkClick('terms')} className="hover:text-purple-400 transition">Terms of Use</button>
                        <span>|</span>
                        <a href="mailto:contact@nomadvisa.help" className="hover:text-purple-400 transition">Contact</a>
                        <span>|</span>
                        <a href="https://nomadvisa.help/FAQs.html" className="hover:text-purple-400 transition">FAQs</a>
                    </div>
                    <p className="text-slate-600 text-xs mt-4">¬© 2025 Where to Next? All data is for informational purposes. Always verify with official sources.</p>
                </footer>
            );
        }

        // --- MAIN APP COMPONENT ---
        function App() {
            const [allData, setAllData] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [funnelStep, setFunnelStep] = React.useState(1);
            const [selectedNationality, setSelectedNationality] = React.useState('');
            const [selectedIncomeValue, setSelectedIncomeValue] = React.useState("any");
            const [selectedDuration, setSelectedDuration] = React.useState(0);
            const [selectedLifestyle, setSelectedLifestyle] = React.useState('Any');
            const [modalContent, setModalContent] = React.useState(null);
            const [infoModalContent, setInfoModalContent] = React.useState(null);
            const [showNewsletterModal, setShowNewsletterModal] = React.useState(false);
            
            React.useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch('./data/data.json');
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        const jsonData = await response.json();
                        if(Array.isArray(jsonData)) {
                            setAllData(jsonData);
                        } else {
                            throw new Error("Data format is incorrect, expected an array.");
                        }
                    } catch (e) {
                        console.error("Fetch error:", e);
                        setError("Could not load visa data.");
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);
            
            React.useEffect(() => {
                let timer;
                if (funnelStep === 4) {
                    timer = setTimeout(() => setShowNewsletterModal(true), 5000);
                }
                return () => clearTimeout(timer);
            }, [funnelStep]);

            const filteredVisas = React.useMemo(() => {
                if (!allData || allData.length === 0) return [];
                const incomeOption = incomeLevels.find(level => level.value === selectedIncomeValue);
                const userIncome = incomeOption?.userIncomeForMatch;
                const userClusters = selectedNationality ? nationalityToClusters(selectedNationality) : [];

                return allData.flatMap(country => {
                    if (!country || !country.visas) return [];
                    
                    if (selectedLifestyle !== 'Any') {
                        const rating = country.ratings?.[selectedLifestyle];
                        if (!rating || rating.score < 4) return [];
                    }

                    return country.visas
                        .filter(visa => {
                            if (!visa) return false;
                            
                            if (selectedNationality) {
                                const visaCluster = visa.eligible_citizens_cluster || '';
                                if (!userClusters.includes(visaCluster) && visaCluster !== 'All Nationalities') return false;
                            }
                            
                            if (userIncome !== null) {
                                const visaIncome = visa.income_requirement_usd_month;
                                if (userIncome === 0 && (visaIncome !== 0 && visaIncome != null)) return false;
                                if (userIncome > 0 && (visaIncome == null || visaIncome > userIncome)) return false;
                            }

                            if ((visa.visa_length_months || 0) < selectedDuration) return false;
                            
                            return true;
                        })
                        .map(visa => ({ country, visa }));
                });
            }, [allData, selectedNationality, selectedIncomeValue, selectedDuration, selectedLifestyle]);
            
            const allCountryNames = React.useMemo(() => allData.filter(c => c && c.country_name).map(c => c.country_name).sort(), [allData]);
            const infoContent = { 
                terms: { title: 'Terms of Use', content: `<p>This tool is for informational purposes only and does not constitute legal or financial advice. Visa requirements change frequently. Always verify all information with official government sources before making any plans or payments.</p>` },
                about: { title: 'About This Project', content: `<p>This tool was built to cut through the noise. Finding your next place to live shouldn't be a bureaucratic nightmare of 20 open tabs and conflicting information.</p><p>The goal is to provide a clear, user-friendly platform to compare visas based on factors that actually matter to nomads and expats: lifestyle, visa requirements, and the real-world cost of living and bureaucracy. All data is aggregated from official government sources, reputable immigration forums, and cross-referenced for accuracy.</p>` },
                howToUse: { title: 'How to Use This Tool', content: `<p>Get the best results in a few simple steps:</p><ol class="list-decimal list-inside space-y-2"><li><strong>Go through the initial funnel:</strong> Select Your Nationality, Income, and desired Stay duration to get a baseline.</li><li><strong>Refine with Lifestyle:</strong> Use the "What Matters Most?" filter to find visas in countries that have a high score for the lifestyle factor you prioritize.</li><li><strong>Explore the Cards:</strong> Click any visa card to see a detailed breakdown.</li></ol>`}
            };

            return (
                <div className={`min-h-screen bg-slate-900 text-gray-100 font-sans ${funnelStep < 4 ? 'funnel-active' : ''}`}>
                    {funnelStep < 4 && (
                        <GuidedFunnel 
                            step={funnelStep}
                            onAdvance={() => setFunnelStep(step => step + 1)}
                            onSkip={() => setFunnelStep(4)}
                            setters={{ nationality: setSelectedNationality, income: setSelectedIncomeValue, duration: setSelectedDuration }}
                            values={{ nationality: selectedNationality, income: selectedIncomeValue, duration: selectedDuration }}
                            allCountries={allCountryNames}
                            matchingCount={filteredVisas.length}
                        />
                    )}

                    <div className="main-content p-4 sm:p-6 md:p-8">
                        <Navbar onLinkClick={(id) => setInfoModalContent(infoContent[id])} />
                        <header className="text-center mb-8 max-w-4xl mx-auto">
                            <h1 className="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">Find Your Perfect Visa</h1>
                        </header>
                         <div className="bg-slate-800/80 backdrop-blur-sm shadow-2xl rounded-xl p-6 mb-10 max-w-6xl mx-auto">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Your Nationality</label>
                                    <NationalitySelector selectedNationality={selectedNationality} onSelectNationality={setSelectedNationality} allCountries={allCountryNames}/>
                                </div>
                                <div>
                                   <label className="block text-sm font-medium text-slate-300 mb-2">Monthly Income (USD)</label>
                                   <div className="flex flex-wrap gap-2">{incomeLevels.map(level => (
                                           <button key={level.value} onClick={() => setSelectedIncomeValue(level.value)}
                                                   className={`flex-1 px-2 py-2 text-xs rounded-md transition-all ${selectedIncomeValue === level.value ? 'bg-purple-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}>{level.label}</button>
                                       ))}</div>
                               </div>
                               <div>
                                   <label className="block text-sm font-medium text-slate-300 mb-2">Minimum Stay</label>
                                   <div className="flex flex-wrap gap-2">{durationOptions.map(opt => (
                                           <button key={opt.label} onClick={() => setSelectedDuration(opt.months)}
                                               className={`flex-1 px-2 py-2 text-xs rounded-md transition-all ${selectedDuration === opt.months ? 'bg-purple-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}>{opt.label}</button>
                                       ))}</div>
                               </div>
                               <div>
                                   <label className="block text-sm font-medium text-slate-300 mb-2">What Matters Most?</label>
                                   <select value={selectedLifestyle} onChange={e => setSelectedLifestyle(e.target.value)} className="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:border-purple-500 focus:ring-purple-500 text-sm">
                                       <option value="Any">Anything</option>
                                       {lifestyleOptions.map(key => <option key={key} value={key}>{LIFESTYLE_MAP[key]}</option>)}
                                   </select>
                               </div>
                            </div>
                        </div>

                        <main className="max-w-7xl mx-auto">
                           {isLoading ? ( <p className="text-center text-slate-400 text-lg">Loading Visa Options...</p> ) : 
                           error ? ( <div className="text-center text-red-400 bg-red-900/50 p-4 rounded-lg">{error}</div> ) : (
                            <>
                                <div className="mb-6 text-center">
                                    <h2 className="text-2xl font-bold text-slate-300 transition-all duration-300">
                                        Showing <span className="text-purple-400">{filteredVisas.length}</span> Matching Visa Options
                                    </h2>
                                    {allData.length > 0 && filteredVisas.length === 0 && <p className="text-slate-400 mt-2">No visas match your current criteria. Try adjusting the filters!</p>}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredVisas.map(({ country, visa }) => (
                                        <VisaCard 
                                            key={`${country.country_name}-${visa.visa_name}`} 
                                            country={country} 
                                            visa={visa} 
                                            onViewDetails={setModalContent} 
                                        />
                                    ))}
                                </div>
                            </>
                           )}
                        </main>
                        <Footer onLinkClick={(id) => setInfoModalContent(infoContent[id])} />
                    </div>
                    
                    {modalContent && <DetailsModal country={modalContent} onClose={() => setModalContent(null)} />}
                    {infoModalContent && <InfoModal data={infoModalContent} onClose={() => setInfoModalContent(null)} />}
                    <ConvertKitModal show={showNewsletterModal} onClose={() => setShowNewsletterModal(false)} />
                </div>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
